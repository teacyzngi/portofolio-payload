{"version":3,"file":"index.js","names":["React","useCallback","useEffect","useMemo","useState","v4","uuidv4","defaultOptions","CodeEditor","RenderCustomComponent","useField","withCondition","FieldDescription","FieldError","FieldLabel","mergeFieldStyles","fieldBaseClass","baseClass","JSONFieldComponent","props","field","admin","className","description","editorOptions","maxHeight","jsonSchema","label","localized","required","path","pathFromProps","readOnly","validate","insertSpaces","tabSize","formatJSON","value","undefined","JSON","stringify","jsonError","setJsonError","inputChangeFromRef","useRef","recalculatedHeightAt","setRecalculatedHeightAt","Date","now","memoizedValidate","options","customComponents","AfterInput","BeforeInput","Description","Error","Label","disabled","initialValue","setValue","showError","potentiallyStalePath","stringValueRef","handleMount","editor","monaco","languages","json","jsonDefaults","setDiagnosticsOptions","enableSchemaRequest","schemas","diagnosticsOptions","uri","newUri","includes","crypto","randomUUID","setModel","createModel","Uri","parse","handleChange","val","current","e","newStringValue","styles","_jsxs","filter","Boolean","join","style","_jsx","CustomComponent","Fallback","message","defaultLanguage","onChange","onMount","wrapperProps","id","replace","JSONField"],"sources":["../../../src/fields/JSON/index.tsx"],"sourcesContent":["'use client'\nimport type { JSONFieldClientComponent, JsonObject } from 'payload'\n\nimport { type OnMount } from '@monaco-editor/react'\nimport React, { useCallback, useEffect, useMemo, useState } from 'react'\nimport { v4 as uuidv4 } from 'uuid'\n\nimport { defaultOptions } from '../../elements/CodeEditor/constants.js'\nimport { CodeEditor } from '../../elements/CodeEditor/index.js'\nimport { RenderCustomComponent } from '../../elements/RenderCustomComponent/index.js'\nimport { useField } from '../../forms/useField/index.js'\nimport { withCondition } from '../../forms/withCondition/index.js'\nimport { FieldDescription } from '../FieldDescription/index.js'\nimport { FieldError } from '../FieldError/index.js'\nimport { FieldLabel } from '../FieldLabel/index.js'\nimport { mergeFieldStyles } from '../mergeFieldStyles.js'\nimport { fieldBaseClass } from '../shared/index.js'\nimport './index.scss'\n\nconst baseClass = 'json-field'\n\nconst JSONFieldComponent: JSONFieldClientComponent = (props) => {\n  const {\n    field,\n    field: {\n      admin: { className, description, editorOptions, maxHeight } = {},\n      jsonSchema,\n      label,\n      localized,\n      required,\n    },\n    path: pathFromProps,\n    readOnly,\n    validate,\n  } = props\n\n  const { insertSpaces = defaultOptions.insertSpaces, tabSize = defaultOptions.tabSize } =\n    editorOptions || {}\n\n  const formatJSON = useCallback(\n    (value: JsonObject | undefined): string | undefined => {\n      if (value === undefined) {\n        return undefined\n      }\n      if (value === null) {\n        return ''\n      }\n      return insertSpaces ? JSON.stringify(value, null, tabSize) : JSON.stringify(value, null, '\\t')\n    },\n    [tabSize, insertSpaces],\n  )\n\n  const [jsonError, setJsonError] = useState<string>()\n  const inputChangeFromRef = React.useRef<'formState' | 'internalEditor'>('formState')\n  const [recalculatedHeightAt, setRecalculatedHeightAt] = useState<number | undefined>(Date.now())\n\n  const memoizedValidate = useCallback(\n    (value, options) => {\n      if (typeof validate === 'function') {\n        return validate(value, { ...options, jsonError, required })\n      }\n    },\n    [validate, required, jsonError],\n  )\n\n  const {\n    customComponents: { AfterInput, BeforeInput, Description, Error, Label } = {},\n    disabled,\n    initialValue,\n    path,\n    setValue,\n    showError,\n    value,\n  } = useField<JsonObject>({\n    potentiallyStalePath: pathFromProps,\n    validate: memoizedValidate,\n  })\n\n  const stringValueRef = React.useRef<string>(formatJSON(value ?? initialValue))\n\n  const handleMount = useCallback<OnMount>(\n    (editor, monaco) => {\n      if (!jsonSchema) {\n        return\n      }\n\n      monaco.languages.json.jsonDefaults.setDiagnosticsOptions({\n        enableSchemaRequest: true,\n        schemas: [\n          ...(monaco.languages.json.jsonDefaults.diagnosticsOptions.schemas || []),\n          jsonSchema,\n        ],\n        validate: true,\n      })\n\n      const uri = jsonSchema.uri\n      const newUri = uri.includes('?')\n        ? `${uri}&${crypto.randomUUID ? crypto.randomUUID() : uuidv4()}`\n        : `${uri}?${crypto.randomUUID ? crypto.randomUUID() : uuidv4()}`\n\n      editor.setModel(\n        monaco.editor.createModel(formatJSON(value) || '', 'json', monaco.Uri.parse(newUri)),\n      )\n    },\n    [jsonSchema, formatJSON, value],\n  )\n\n  const handleChange = useCallback(\n    (val: string) => {\n      if (readOnly || disabled) {\n        return\n      }\n      inputChangeFromRef.current = 'internalEditor'\n\n      try {\n        setValue(val ? JSON.parse(val) : null)\n        stringValueRef.current = val\n        setJsonError(undefined)\n      } catch (e) {\n        setValue(val ? val : null)\n        stringValueRef.current = val\n        setJsonError(e)\n      }\n    },\n    [readOnly, disabled, setValue],\n  )\n\n  useEffect(() => {\n    if (inputChangeFromRef.current === 'formState') {\n      const newStringValue = formatJSON(value ?? initialValue)\n      if (newStringValue !== stringValueRef.current) {\n        stringValueRef.current = newStringValue\n        setRecalculatedHeightAt(Date.now())\n      }\n    }\n\n    inputChangeFromRef.current = 'formState'\n  }, [initialValue, path, formatJSON, value])\n\n  const styles = useMemo(() => mergeFieldStyles(field), [field])\n\n  return (\n    <div\n      className={[\n        fieldBaseClass,\n        baseClass,\n        className,\n        showError && 'error',\n        (readOnly || disabled) && 'read-only',\n      ]\n        .filter(Boolean)\n        .join(' ')}\n      style={styles}\n    >\n      <RenderCustomComponent\n        CustomComponent={Label}\n        Fallback={\n          <FieldLabel label={label} localized={localized} path={path} required={required} />\n        }\n      />\n      <div className={`${fieldBaseClass}__wrap`}>\n        <RenderCustomComponent\n          CustomComponent={Error}\n          Fallback={<FieldError message={jsonError} path={path} showError={showError} />}\n        />\n        {BeforeInput}\n        <CodeEditor\n          defaultLanguage=\"json\"\n          maxHeight={maxHeight}\n          onChange={handleChange}\n          onMount={handleMount}\n          options={editorOptions}\n          readOnly={readOnly || disabled}\n          recalculatedHeightAt={recalculatedHeightAt}\n          value={stringValueRef.current}\n          wrapperProps={{\n            id: `field-${path?.replace(/\\./g, '__')}`,\n          }}\n        />\n        {AfterInput}\n      </div>\n      <RenderCustomComponent\n        CustomComponent={Description}\n        Fallback={<FieldDescription description={description} path={path} />}\n      />\n    </div>\n  )\n}\n\nexport const JSONField = withCondition(JSONFieldComponent)\n"],"mappings":"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","ignoreList":[]}