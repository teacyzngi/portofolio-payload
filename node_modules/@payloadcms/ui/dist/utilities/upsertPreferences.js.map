{"version":3,"file":"upsertPreferences.js","names":["dequal","cache","removeUndefined","defaultMerge","existingValue","incomingValue","getPreferences","key","payload","userID","userSlug","result","find","collection","depth","limit","pagination","where","and","equals","then","res","docs","upsertPreferences","customMerge","req","value","existingPrefs","user","id","newPrefs","create","data","disableTransaction","mergedPrefs","update"],"sources":["../../src/utilities/upsertPreferences.ts"],"sourcesContent":["import type { DefaultDocumentIDType, Payload, PayloadRequest } from 'payload'\n\nimport { dequal } from 'dequal/lite'\nimport { cache } from 'react'\n\nimport { removeUndefined } from './removeUndefined.js'\n\ntype PreferenceDoc<T> = {\n  id: DefaultDocumentIDType | undefined\n  value?: T | undefined\n}\n\ntype DefaultMerge = <T>(existingValue: T, incomingValue: T | undefined) => T\n\nconst defaultMerge: DefaultMerge = <T>(existingValue: T, incomingValue: T | undefined) =>\n  ({\n    ...(typeof existingValue === 'object' ? existingValue : {}), // Shallow merge existing prefs to acquire any missing keys from incoming value\n    ...removeUndefined(incomingValue || {}),\n  }) as T\n\nexport const getPreferences = cache(\n  async <T>(\n    key: string,\n    payload: Payload,\n    userID: DefaultDocumentIDType,\n    userSlug: string,\n  ): Promise<PreferenceDoc<T>> => {\n    const result = (await payload\n      .find({\n        collection: 'payload-preferences',\n        depth: 0,\n        limit: 1,\n        pagination: false,\n        where: {\n          and: [\n            {\n              key: {\n                equals: key,\n              },\n            },\n            {\n              'user.relationTo': {\n                equals: userSlug,\n              },\n            },\n            {\n              'user.value': {\n                equals: userID,\n              },\n            },\n          ],\n        },\n      })\n      .then((res) => res.docs?.[0])) as { id: DefaultDocumentIDType; value: T }\n\n    return result\n  },\n)\n\n/**\n * Will update the given preferences by key, creating a new record if it doesn't already exist, or merging existing preferences with the new value.\n * This is not possible to do with the existing `db.upsert` operation because it stores on the `value` key and does not perform a deep merge beyond the first level.\n * I.e. if you have a preferences record with a `value` key, `db.upsert` will overwrite the existing value. In the future if this supported we should use that instead.\n * @param req - The PayloadRequest object\n * @param key - The key of the preferences to update\n * @param value - The new value to merge with the existing preferences\n */\nexport const upsertPreferences = async <T extends Record<string, unknown> | string>({\n  customMerge,\n  key,\n  req,\n  value: incomingValue,\n}: {\n  customMerge?: (existingValue: T, incomingValue: T, defaultMerge: DefaultMerge) => T\n  key: string\n  req: PayloadRequest\n  value: T\n}): Promise<T> => {\n  const existingPrefs: PreferenceDoc<T> = req.user\n    ? await getPreferences<T>(key, req.payload, req.user.id, req.user.collection)\n    : ({} as PreferenceDoc<T>)\n\n  let newPrefs = existingPrefs?.value\n\n  if (!existingPrefs?.id) {\n    await req.payload.create({\n      collection: 'payload-preferences',\n      data: {\n        key,\n        user: {\n          collection: req.user.collection,\n          value: req.user.id,\n        },\n        value: incomingValue,\n      },\n      depth: 0,\n      disableTransaction: true,\n      user: req.user,\n    })\n  } else {\n    let mergedPrefs: T\n\n    if (typeof customMerge === 'function') {\n      mergedPrefs = customMerge(existingPrefs.value, incomingValue, defaultMerge)\n    } else {\n      // Strings are valid JSON, i.e. `locale` saved as a string to the locale preferences\n      mergedPrefs =\n        typeof incomingValue === 'object'\n          ? defaultMerge<T>(existingPrefs.value, incomingValue)\n          : incomingValue\n    }\n\n    if (!dequal(mergedPrefs, existingPrefs.value)) {\n      newPrefs = await req.payload\n        .update({\n          id: existingPrefs.id,\n          collection: 'payload-preferences',\n          data: {\n            key,\n            user: {\n              collection: req.user.collection,\n              value: req.user.id,\n            },\n            value: mergedPrefs,\n          },\n          depth: 0,\n          disableTransaction: true,\n          user: req.user,\n        })\n        ?.then((res) => res.value)\n    }\n  }\n\n  return newPrefs\n}\n"],"mappings":"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","ignoreList":[]}