{"version":3,"sources":["../src/deleteOne.ts"],"sourcesContent":["import type { DeleteOne } from 'payload'\n\nimport { eq } from 'drizzle-orm'\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter } from './types.js'\n\nimport { buildFindManyArgs } from './find/buildFindManyArgs.js'\nimport { buildQuery } from './queries/buildQuery.js'\nimport { selectDistinct } from './queries/selectDistinct.js'\nimport { transform } from './transform/read/index.js'\nimport { getTransaction } from './utilities/getTransaction.js'\n\nexport const deleteOne: DeleteOne = async function deleteOne(\n  this: DrizzleAdapter,\n  { collection: collectionSlug, req, returning, select, where: whereArg },\n) {\n  const db = await getTransaction(this, req)\n  const collection = this.payload.collections[collectionSlug].config\n\n  const tableName = this.tableNameMap.get(toSnakeCase(collection.slug))\n\n  let docToDelete: Record<string, unknown>\n\n  const { joins, selectFields, where } = buildQuery({\n    adapter: this,\n    fields: collection.flattenedFields,\n    locale: req?.locale,\n    tableName,\n    where: whereArg,\n  })\n\n  const selectDistinctResult = await selectDistinct({\n    adapter: this,\n    db,\n    joins,\n    query: ({ query }) => query.limit(1),\n    selectFields,\n    tableName,\n    where,\n  })\n\n  if (selectDistinctResult?.[0]?.id) {\n    docToDelete = await db.query[tableName].findFirst({\n      where: eq(this.tables[tableName].id, selectDistinctResult[0].id),\n    })\n  } else {\n    const findManyArgs = buildFindManyArgs({\n      adapter: this,\n      depth: 0,\n      fields: collection.flattenedFields,\n      joinQuery: false,\n      select,\n      tableName,\n    })\n\n    findManyArgs.where = where\n\n    docToDelete = await db.query[tableName].findFirst(findManyArgs)\n  }\n\n  if (!docToDelete) {\n    return null\n  }\n\n  const result =\n    returning === false\n      ? null\n      : transform({\n          adapter: this,\n          config: this.payload.config,\n          data: docToDelete,\n          fields: collection.flattenedFields,\n          joinQuery: false,\n          tableName,\n        })\n\n  await this.deleteWhere({\n    db,\n    tableName,\n    where: eq(this.tables[tableName].id, docToDelete.id),\n  })\n\n  return result\n}\n"],"names":["eq","toSnakeCase","buildFindManyArgs","buildQuery","selectDistinct","transform","getTransaction","deleteOne","collection","collectionSlug","req","returning","select","where","whereArg","db","payload","collections","config","tableName","tableNameMap","get","slug","docToDelete","joins","selectFields","adapter","fields","flattenedFields","locale","selectDistinctResult","query","limit","id","findFirst","tables","findManyArgs","depth","joinQuery","result","data","deleteWhere"],"mappings":"AAEA,SAASA,EAAE,QAAQ,cAAa;AAChC,OAAOC,iBAAiB,gBAAe;AAIvC,SAASC,iBAAiB,QAAQ,8BAA6B;AAC/D,SAASC,UAAU,QAAQ,0BAAyB;AACpD,SAASC,cAAc,QAAQ,8BAA6B;AAC5D,SAASC,SAAS,QAAQ,4BAA2B;AACrD,SAASC,cAAc,QAAQ,gCAA+B;AAE9D,OAAO,MAAMC,YAAuB,eAAeA,UAEjD,EAAEC,YAAYC,cAAc,EAAEC,GAAG,EAAEC,SAAS,EAAEC,MAAM,EAAEC,OAAOC,QAAQ,EAAE;IAEvE,MAAMC,KAAK,MAAMT,eAAe,IAAI,EAAEI;IACtC,MAAMF,aAAa,IAAI,CAACQ,OAAO,CAACC,WAAW,CAACR,eAAe,CAACS,MAAM;IAElE,MAAMC,YAAY,IAAI,CAACC,YAAY,CAACC,GAAG,CAACpB,YAAYO,WAAWc,IAAI;IAEnE,IAAIC;IAEJ,MAAM,EAAEC,KAAK,EAAEC,YAAY,EAAEZ,KAAK,EAAE,GAAGV,WAAW;QAChDuB,SAAS,IAAI;QACbC,QAAQnB,WAAWoB,eAAe;QAClCC,QAAQnB,KAAKmB;QACbV;QACAN,OAAOC;IACT;IAEA,MAAMgB,uBAAuB,MAAM1B,eAAe;QAChDsB,SAAS,IAAI;QACbX;QACAS;QACAO,OAAO,CAAC,EAAEA,KAAK,EAAE,GAAKA,MAAMC,KAAK,CAAC;QAClCP;QACAN;QACAN;IACF;IAEA,IAAIiB,sBAAsB,CAAC,EAAE,EAAEG,IAAI;QACjCV,cAAc,MAAMR,GAAGgB,KAAK,CAACZ,UAAU,CAACe,SAAS,CAAC;YAChDrB,OAAOb,GAAG,IAAI,CAACmC,MAAM,CAAChB,UAAU,CAACc,EAAE,EAAEH,oBAAoB,CAAC,EAAE,CAACG,EAAE;QACjE;IACF,OAAO;QACL,MAAMG,eAAelC,kBAAkB;YACrCwB,SAAS,IAAI;YACbW,OAAO;YACPV,QAAQnB,WAAWoB,eAAe;YAClCU,WAAW;YACX1B;YACAO;QACF;QAEAiB,aAAavB,KAAK,GAAGA;QAErBU,cAAc,MAAMR,GAAGgB,KAAK,CAACZ,UAAU,CAACe,SAAS,CAACE;IACpD;IAEA,IAAI,CAACb,aAAa;QAChB,OAAO;IACT;IAEA,MAAMgB,SACJ5B,cAAc,QACV,OACAN,UAAU;QACRqB,SAAS,IAAI;QACbR,QAAQ,IAAI,CAACF,OAAO,CAACE,MAAM;QAC3BsB,MAAMjB;QACNI,QAAQnB,WAAWoB,eAAe;QAClCU,WAAW;QACXnB;IACF;IAEN,MAAM,IAAI,CAACsB,WAAW,CAAC;QACrB1B;QACAI;QACAN,OAAOb,GAAG,IAAI,CAACmC,MAAM,CAAChB,UAAU,CAACc,EAAE,EAAEV,YAAYU,EAAE;IACrD;IAEA,OAAOM;AACT,EAAC"}