{"version":3,"sources":["../../src/schema/build.ts"],"sourcesContent":["import type { FlattenedField, SanitizedCompoundIndex } from 'payload'\n\nimport { InvalidConfiguration } from 'payload'\nimport toSnakeCase from 'to-snake-case'\n\nimport type {\n  DrizzleAdapter,\n  IDType,\n  RawColumn,\n  RawForeignKey,\n  RawIndex,\n  RawRelation,\n  RawTable,\n  RelationMap,\n  SetColumnID,\n} from '../types.js'\n\nimport { createTableName } from '../createTableName.js'\nimport { buildIndexName } from '../utilities/buildIndexName.js'\nimport { traverseFields } from './traverseFields.js'\n\ntype Args = {\n  adapter: DrizzleAdapter\n  baseColumns?: Record<string, RawColumn>\n  /**\n   * After table is created, run these functions to add extra config to the table\n   * ie. indexes, multiple columns, etc\n   */\n  baseForeignKeys?: Record<string, RawForeignKey>\n  /**\n   * After table is created, run these functions to add extra config to the table\n   * ie. indexes, multiple columns, etc\n   */\n  baseIndexes?: Record<string, RawIndex>\n  blocksTableNameMap: Record<string, number>\n  buildNumbers?: boolean\n  buildRelationships?: boolean\n  compoundIndexes?: SanitizedCompoundIndex[]\n  disableNotNull: boolean\n  disableRelsTableUnique?: boolean\n  disableUnique: boolean\n  fields: FlattenedField[]\n  parentIsLocalized: boolean\n  rootRelationships?: Set<string>\n  rootRelationsToBuild?: RelationMap\n  rootTableIDColType?: IDType\n  rootTableName?: string\n  rootUniqueRelationships?: Set<string>\n  setColumnID: SetColumnID\n  tableName: string\n  timestamps?: boolean\n  versions: boolean\n  /**\n   * Tracks whether or not this table is built\n   * from the result of a localized array or block field at some point\n   */\n  withinLocalizedArrayOrBlock?: boolean\n}\n\ntype Result = {\n  hasLocalizedManyNumberField: boolean\n  hasLocalizedManyTextField: boolean\n  hasLocalizedRelationshipField: boolean\n  hasManyNumberField: 'index' | boolean\n  hasManyTextField: 'index' | boolean\n  relationsToBuild: RelationMap\n}\n\nexport const buildTable = ({\n  adapter,\n  baseColumns = {},\n  baseForeignKeys = {},\n  baseIndexes = {},\n  blocksTableNameMap,\n  compoundIndexes,\n  disableNotNull,\n  disableRelsTableUnique = false,\n  disableUnique = false,\n  fields,\n  parentIsLocalized,\n  rootRelationships,\n  rootRelationsToBuild,\n  rootTableIDColType,\n  rootTableName: incomingRootTableName,\n  rootUniqueRelationships,\n  setColumnID,\n  tableName,\n  timestamps,\n  versions,\n  withinLocalizedArrayOrBlock,\n}: Args): Result => {\n  const isRoot = !incomingRootTableName\n  const rootTableName = incomingRootTableName || tableName\n  const columns: Record<string, RawColumn> = baseColumns\n  const indexes: Record<string, RawIndex> = baseIndexes\n\n  const localesColumns: Record<string, RawColumn> = {}\n  const localesIndexes: Record<string, RawIndex> = {}\n  let localesTable: RawTable\n  let textsTable: RawTable\n  let numbersTable: RawTable\n\n  // Relationships to the base collection\n  const relationships: Set<string> = rootRelationships || new Set()\n\n  // Unique relationships to the base collection\n  const uniqueRelationships: Set<string> = rootUniqueRelationships || new Set()\n\n  let relationshipsTable: RawTable\n\n  // Drizzle relations\n  const relationsToBuild: RelationMap = new Map()\n\n  const idColType: IDType = setColumnID({ adapter, columns, fields })\n\n  const {\n    hasLocalizedField,\n    hasLocalizedManyNumberField,\n    hasLocalizedManyTextField,\n    hasLocalizedRelationshipField,\n    hasManyNumberField,\n    hasManyTextField,\n  } = traverseFields({\n    adapter,\n    blocksTableNameMap,\n    columns,\n    disableNotNull,\n    disableRelsTableUnique,\n    disableUnique,\n    fields,\n    indexes,\n    localesColumns,\n    localesIndexes,\n    newTableName: tableName,\n    parentIsLocalized,\n    parentTableName: tableName,\n    relationships,\n    relationsToBuild,\n    rootRelationsToBuild: rootRelationsToBuild || relationsToBuild,\n    rootTableIDColType: rootTableIDColType || idColType,\n    rootTableName,\n    setColumnID,\n    uniqueRelationships,\n    versions,\n    withinLocalizedArrayOrBlock,\n  })\n\n  // split the relationsToBuild by localized and non-localized\n  const localizedRelations = new Map()\n  const nonLocalizedRelations = new Map()\n\n  relationsToBuild.forEach(({ type, localized, relationName, target }, key) => {\n    const map = localized ? localizedRelations : nonLocalizedRelations\n    map.set(key, { type, relationName, target })\n  })\n\n  if (timestamps) {\n    columns.createdAt = {\n      name: 'created_at',\n      type: 'timestamp',\n      defaultNow: true,\n      mode: 'string',\n      notNull: true,\n      precision: 3,\n      withTimezone: true,\n    }\n\n    columns.updatedAt = {\n      name: 'updated_at',\n      type: 'timestamp',\n      defaultNow: true,\n      mode: 'string',\n      notNull: true,\n      precision: 3,\n      withTimezone: true,\n    }\n  }\n\n  const table: RawTable = {\n    name: tableName,\n    columns,\n    foreignKeys: baseForeignKeys,\n    indexes,\n  }\n\n  adapter.rawTables[tableName] = table\n\n  if (hasLocalizedField || localizedRelations.size) {\n    const localeTableName = `${tableName}${adapter.localesSuffix}`\n    localesColumns.id = {\n      name: 'id',\n      type: 'serial',\n      primaryKey: true,\n    }\n\n    localesColumns._locale = {\n      name: '_locale',\n      type: 'enum',\n      locale: true,\n      notNull: true,\n    }\n\n    localesColumns._parentID = {\n      name: '_parent_id',\n      type: idColType,\n      notNull: true,\n    }\n\n    localesIndexes._localeParent = {\n      name: `${localeTableName}_locale_parent_id_unique`,\n      on: ['_locale', '_parentID'],\n      unique: true,\n    }\n\n    localesTable = {\n      name: localeTableName,\n      columns: localesColumns,\n      foreignKeys: {\n        _parentIdFk: {\n          name: `${localeTableName}_parent_id_fk`,\n          columns: ['_parentID'],\n          foreignColumns: [\n            {\n              name: 'id',\n              table: tableName,\n            },\n          ],\n          onDelete: 'cascade',\n        },\n      },\n      indexes: localesIndexes,\n    }\n\n    adapter.rawTables[localeTableName] = localesTable\n\n    const localeRelations: Record<string, RawRelation> = {\n      _parentID: {\n        type: 'one',\n        fields: [\n          {\n            name: '_parentID',\n            table: localeTableName,\n          },\n        ],\n        references: ['id'],\n        relationName: '_locales',\n        to: tableName,\n      },\n    }\n\n    localizedRelations.forEach(({ type, target }, key) => {\n      if (type === 'one') {\n        localeRelations[key] = {\n          type: 'one',\n          fields: [\n            {\n              name: key,\n              table: localeTableName,\n            },\n          ],\n          references: ['id'],\n          relationName: key,\n          to: target,\n        }\n      }\n      if (type === 'many') {\n        localeRelations[key] = {\n          type: 'many',\n          relationName: key,\n          to: target,\n        }\n      }\n    })\n    adapter.rawRelations[localeTableName] = localeRelations\n  }\n\n  if (compoundIndexes) {\n    for (const index of compoundIndexes) {\n      let someLocalized: boolean | null = null\n      const columns: string[] = []\n\n      const getTableToUse = () => {\n        if (someLocalized) {\n          return localesTable\n        }\n\n        return table\n      }\n\n      for (const { path, pathHasLocalized } of index.fields) {\n        if (someLocalized === null) {\n          someLocalized = pathHasLocalized\n        }\n\n        if (someLocalized !== pathHasLocalized) {\n          throw new InvalidConfiguration(\n            `Compound indexes within localized and non localized fields are not supported in SQL. Expected ${path} to be ${someLocalized ? 'non' : ''} localized.`,\n          )\n        }\n\n        const columnPath = path.replaceAll('.', '_')\n\n        if (!getTableToUse().columns[columnPath]) {\n          throw new InvalidConfiguration(\n            `Column ${columnPath} for compound index on ${path} was not found in the ${getTableToUse().name} table.`,\n          )\n        }\n\n        columns.push(columnPath)\n      }\n\n      if (someLocalized) {\n        columns.push('_locale')\n      }\n\n      let name = columns.join('_')\n      // truncate against the limit, buildIndexName will handle collisions\n      if (name.length > 63) {\n        name = 'compound_index'\n      }\n\n      const indexName = buildIndexName({ name, adapter })\n\n      getTableToUse().indexes[indexName] = {\n        name: indexName,\n        on: columns,\n        unique: disableUnique ? false : index.unique,\n      }\n    }\n  }\n\n  if (isRoot) {\n    if (hasManyTextField) {\n      const textsTableName = `${rootTableName}_texts`\n\n      const columns: Record<string, RawColumn> = {\n        id: {\n          name: 'id',\n          type: 'serial',\n          primaryKey: true,\n        },\n        order: {\n          name: 'order',\n          type: 'integer',\n          notNull: true,\n        },\n        parent: {\n          name: 'parent_id',\n          type: idColType,\n          notNull: true,\n        },\n        path: {\n          name: 'path',\n          type: 'varchar',\n\n          notNull: true,\n        },\n        text: {\n          name: 'text',\n          type: 'varchar',\n        },\n      }\n\n      if (hasLocalizedManyTextField) {\n        columns.locale = {\n          name: 'locale',\n          type: 'enum',\n          locale: true,\n        }\n      }\n\n      const textsTableIndexes: Record<string, RawIndex> = {\n        orderParentIdx: {\n          name: `${textsTableName}_order_parent_idx`,\n          on: ['order', 'parent'],\n        },\n      }\n\n      if (hasManyTextField === 'index') {\n        textsTableIndexes.text_idx = {\n          name: `${textsTableName}_text_idx`,\n          on: 'text',\n        }\n      }\n\n      if (hasLocalizedManyTextField) {\n        textsTableIndexes.localeParent = {\n          name: `${textsTableName}_locale_parent`,\n          on: ['locale', 'parent'],\n        }\n      }\n\n      textsTable = {\n        name: textsTableName,\n        columns,\n        foreignKeys: {\n          parentFk: {\n            name: `${textsTableName}_parent_fk`,\n            columns: ['parent'],\n            foreignColumns: [\n              {\n                name: 'id',\n                table: tableName,\n              },\n            ],\n            onDelete: 'cascade',\n          },\n        },\n        indexes: textsTableIndexes,\n      }\n\n      adapter.rawTables[textsTableName] = textsTable\n\n      adapter.rawRelations[textsTableName] = {\n        parent: {\n          type: 'one',\n          fields: [\n            {\n              name: 'parent',\n              table: textsTableName,\n            },\n          ],\n          references: ['id'],\n          relationName: '_texts',\n          to: tableName,\n        },\n      }\n    }\n\n    if (hasManyNumberField) {\n      const numbersTableName = `${rootTableName}_numbers`\n      const columns: Record<string, RawColumn> = {\n        id: {\n          name: 'id',\n          type: 'serial',\n          primaryKey: true,\n        },\n        number: {\n          name: 'number',\n          type: 'numeric',\n        },\n        order: {\n          name: 'order',\n          type: 'integer',\n          notNull: true,\n        },\n        parent: {\n          name: 'parent_id',\n          type: idColType,\n          notNull: true,\n        },\n        path: {\n          name: 'path',\n          type: 'varchar',\n          notNull: true,\n        },\n      }\n\n      if (hasLocalizedManyNumberField) {\n        columns.locale = {\n          name: 'locale',\n          type: 'enum',\n          locale: true,\n        }\n      }\n\n      const numbersTableIndexes: Record<string, RawIndex> = {\n        orderParentIdx: { name: `${numbersTableName}_order_parent_idx`, on: ['order', 'parent'] },\n      }\n\n      if (hasManyNumberField === 'index') {\n        numbersTableIndexes.numberIdx = {\n          name: `${numbersTableName}_number_idx`,\n          on: 'number',\n        }\n      }\n\n      if (hasLocalizedManyNumberField) {\n        numbersTableIndexes.localeParent = {\n          name: `${numbersTableName}_locale_parent`,\n          on: ['locale', 'parent'],\n        }\n      }\n\n      numbersTable = {\n        name: numbersTableName,\n        columns,\n        foreignKeys: {\n          parentFk: {\n            name: `${numbersTableName}_parent_fk`,\n            columns: ['parent'],\n            foreignColumns: [\n              {\n                name: 'id',\n                table: tableName,\n              },\n            ],\n            onDelete: 'cascade',\n          },\n        },\n        indexes: numbersTableIndexes,\n      }\n\n      adapter.rawTables[numbersTableName] = numbersTable\n\n      adapter.rawRelations[numbersTableName] = {\n        parent: {\n          type: 'one',\n          fields: [\n            {\n              name: 'parent',\n              table: numbersTableName,\n            },\n          ],\n          references: ['id'],\n          relationName: '_numbers',\n          to: tableName,\n        },\n      }\n    }\n\n    if (relationships.size) {\n      const relationshipColumns: Record<string, RawColumn> = {\n        id: {\n          name: 'id',\n          type: 'serial',\n          primaryKey: true,\n        },\n        order: {\n          name: 'order',\n          type: 'integer',\n        },\n        parent: {\n          name: 'parent_id',\n          type: idColType,\n          notNull: true,\n        },\n        path: {\n          name: 'path',\n          type: 'varchar',\n          notNull: true,\n        },\n      }\n\n      if (hasLocalizedRelationshipField) {\n        relationshipColumns.locale = {\n          name: 'locale',\n          type: 'enum',\n          locale: true,\n        }\n      }\n\n      const relationshipsTableName = `${tableName}${adapter.relationshipsSuffix}`\n\n      const relationshipIndexes: Record<string, RawIndex> = {\n        order: {\n          name: `${relationshipsTableName}_order_idx`,\n          on: 'order',\n        },\n        parentIdx: {\n          name: `${relationshipsTableName}_parent_idx`,\n          on: 'parent',\n        },\n        pathIdx: {\n          name: `${relationshipsTableName}_path_idx`,\n          on: 'path',\n        },\n      }\n\n      if (hasLocalizedRelationshipField) {\n        relationshipIndexes.localeIdx = {\n          name: `${relationshipsTableName}_locale_idx`,\n          on: 'locale',\n        }\n      }\n\n      const relationshipForeignKeys: Record<string, RawForeignKey> = {\n        parentFk: {\n          name: `${relationshipsTableName}_parent_fk`,\n          columns: ['parent'],\n          foreignColumns: [\n            {\n              name: 'id',\n              table: tableName,\n            },\n          ],\n          onDelete: 'cascade',\n        },\n      }\n\n      relationships.forEach((relationTo) => {\n        const relationshipConfig = adapter.payload.collections[relationTo].config\n        const formattedRelationTo = createTableName({\n          adapter,\n          config: relationshipConfig,\n          throwValidationError: true,\n        })\n        let colType: 'integer' | 'numeric' | 'uuid' | 'varchar' =\n          adapter.idType === 'uuid' ? 'uuid' : 'integer'\n        const relatedCollectionCustomIDType =\n          adapter.payload.collections[relationshipConfig.slug]?.customIDType\n\n        if (relatedCollectionCustomIDType === 'number') {\n          colType = 'numeric'\n        }\n        if (relatedCollectionCustomIDType === 'text') {\n          colType = 'varchar'\n        }\n\n        const colName = `${relationTo}ID`\n\n        relationshipColumns[colName] = {\n          name: `${formattedRelationTo}_id`,\n          type: colType,\n        }\n\n        relationshipForeignKeys[`${relationTo}IdFk`] = {\n          name: `${relationshipsTableName}_${toSnakeCase(relationTo)}_fk`,\n          columns: [colName],\n          foreignColumns: [\n            {\n              name: 'id',\n              table: formattedRelationTo,\n            },\n          ],\n          onDelete: 'cascade',\n        }\n\n        const indexColumns = [colName]\n\n        const unique = !disableUnique && uniqueRelationships.has(relationTo)\n\n        if (unique) {\n          indexColumns.push('path')\n        }\n        if (hasLocalizedRelationshipField) {\n          indexColumns.push('locale')\n        }\n\n        const indexName = buildIndexName({\n          name: `${relationshipsTableName}_${formattedRelationTo}_id`,\n          adapter,\n        })\n\n        relationshipIndexes[indexName] = {\n          name: indexName,\n          on: indexColumns,\n          unique,\n        }\n      })\n\n      relationshipsTable = {\n        name: relationshipsTableName,\n        columns: relationshipColumns,\n        foreignKeys: relationshipForeignKeys,\n        indexes: relationshipIndexes,\n      }\n\n      adapter.rawTables[relationshipsTableName] = relationshipsTable\n\n      const relationshipsTableRelations: Record<string, RawRelation> = {\n        parent: {\n          type: 'one',\n          fields: [\n            {\n              name: 'parent',\n              table: relationshipsTableName,\n            },\n          ],\n          references: ['id'],\n          relationName: '_rels',\n          to: tableName,\n        },\n      }\n\n      relationships.forEach((relationTo) => {\n        const relatedTableName = createTableName({\n          adapter,\n          config: adapter.payload.collections[relationTo].config,\n          throwValidationError: true,\n        })\n        const idColumnName = `${relationTo}ID`\n\n        relationshipsTableRelations[idColumnName] = {\n          type: 'one',\n          fields: [\n            {\n              name: idColumnName,\n              table: relationshipsTableName,\n            },\n          ],\n          references: ['id'],\n          relationName: relationTo,\n          to: relatedTableName,\n        }\n      })\n      adapter.rawRelations[relationshipsTableName] = relationshipsTableRelations\n    }\n  }\n\n  const tableRelations: Record<string, RawRelation> = {}\n\n  nonLocalizedRelations.forEach(({ type, relationName, target }, key) => {\n    if (type === 'one') {\n      tableRelations[key] = {\n        type: 'one',\n        fields: [\n          {\n            name: key,\n            table: tableName,\n          },\n        ],\n        references: ['id'],\n        relationName: key,\n        to: target,\n      }\n    }\n    if (type === 'many') {\n      tableRelations[key] = {\n        type: 'many',\n        relationName: relationName || key,\n        to: target,\n      }\n    }\n  })\n\n  if (hasLocalizedField) {\n    tableRelations._locales = {\n      type: 'many',\n      relationName: '_locales',\n      to: localesTable.name,\n    }\n  }\n\n  if (isRoot && textsTable) {\n    tableRelations._texts = {\n      type: 'many',\n      relationName: '_texts',\n      to: textsTable.name,\n    }\n  }\n\n  if (isRoot && numbersTable) {\n    tableRelations._numbers = {\n      type: 'many',\n      relationName: '_numbers',\n      to: numbersTable.name,\n    }\n  }\n\n  if (relationships.size && relationshipsTable) {\n    tableRelations._rels = {\n      type: 'many',\n      relationName: '_rels',\n      to: relationshipsTable.name,\n    }\n  }\n\n  adapter.rawRelations[tableName] = tableRelations\n\n  return {\n    hasLocalizedManyNumberField,\n    hasLocalizedManyTextField,\n    hasLocalizedRelationshipField,\n    hasManyNumberField,\n    hasManyTextField,\n    relationsToBuild,\n  }\n}\n"],"names":["InvalidConfiguration","toSnakeCase","createTableName","buildIndexName","traverseFields","buildTable","adapter","baseColumns","baseForeignKeys","baseIndexes","blocksTableNameMap","compoundIndexes","disableNotNull","disableRelsTableUnique","disableUnique","fields","parentIsLocalized","rootRelationships","rootRelationsToBuild","rootTableIDColType","rootTableName","incomingRootTableName","rootUniqueRelationships","setColumnID","tableName","timestamps","versions","withinLocalizedArrayOrBlock","isRoot","columns","indexes","localesColumns","localesIndexes","localesTable","textsTable","numbersTable","relationships","Set","uniqueRelationships","relationshipsTable","relationsToBuild","Map","idColType","hasLocalizedField","hasLocalizedManyNumberField","hasLocalizedManyTextField","hasLocalizedRelationshipField","hasManyNumberField","hasManyTextField","newTableName","parentTableName","localizedRelations","nonLocalizedRelations","forEach","type","localized","relationName","target","key","map","set","createdAt","name","defaultNow","mode","notNull","precision","withTimezone","updatedAt","table","foreignKeys","rawTables","size","localeTableName","localesSuffix","id","primaryKey","_locale","locale","_parentID","_localeParent","on","unique","_parentIdFk","foreignColumns","onDelete","localeRelations","references","to","rawRelations","index","someLocalized","getTableToUse","path","pathHasLocalized","columnPath","replaceAll","push","join","length","indexName","textsTableName","order","parent","text","textsTableIndexes","orderParentIdx","text_idx","localeParent","parentFk","numbersTableName","number","numbersTableIndexes","numberIdx","relationshipColumns","relationshipsTableName","relationshipsSuffix","relationshipIndexes","parentIdx","pathIdx","localeIdx","relationshipForeignKeys","relationTo","relationshipConfig","payload","collections","config","formattedRelationTo","throwValidationError","colType","idType","relatedCollectionCustomIDType","slug","customIDType","colName","indexColumns","has","relationshipsTableRelations","relatedTableName","idColumnName","tableRelations","_locales","_texts","_numbers","_rels"],"mappings":"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"}