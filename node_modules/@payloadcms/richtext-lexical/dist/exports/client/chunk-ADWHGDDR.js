import{a as ie}from"./chunk-INBEEENE.js";import{b as se}from"./chunk-BZZVLW4U.js";import{jsx as r,jsxs as b,Fragment as we}from"react/jsx-runtime";import O,{createContext as Ie,useCallback as A,useEffect as v,useMemo as N,useRef as S}from"react";import{useLexicalComposerContext as ve}from"@lexical/react/LexicalComposerContext";import{useLexicalEditable as Ne}from"@lexical/react/useLexicalEditable";import{getTranslation as ce}from"@payloadcms/translations";import{Button as ae,Drawer as Oe,EditDepthProvider as Te,Form as $e,formatDrawerSlug as Pe,FormSubmit as Le,RenderFields as Re,ShimmerEffect as Ee,useConfig as je,useDocumentForm as Me,useDocumentInfo as Ae,useEditDepth as Je,useServerFunctions as Ke,useTranslation as ze}from"@payloadcms/ui";import{abortAndIgnore as J}from"@payloadcms/ui/shared";import{$getNodeByKey as K}from"lexical";import{deepCopyObjectSimpleWithoutReactComponents as z,reduceFieldsToValues as He}from"payload/shared";import{v4 as Ve}from"uuid";import{jsx as Ce}from"react/jsx-runtime";import _e from"bson-objectid";import ye from"react";import Be from"bson-objectid";import{DecoratorNode as xe}from"lexical";var x=class extends xe{__cacheBuster;__fields;constructor({cacheBuster:e,fields:t,key:l}){super(l),this.__fields=t,this.__cacheBuster=e||0}static clone(e){return new this({cacheBuster:e.__cacheBuster,fields:e.__fields,key:e.__key})}static getType(){return"inlineBlock"}static importDOM(){return{}}static importJSON(e){return Se(e.fields)}static isInline(){return!1}canIndent(){return!0}createDOM(){let e=document.createElement("span");return e.classList.add("inline-block-container"),e}decorate(e,t){return null}exportDOM(){let e=document.createElement("span");e.classList.add("inline-block-container");let t=document.createTextNode(this.getTextContent());return e.append(t),{element:e}}exportJSON(){return{type:"inlineBlock",fields:this.getFields(),version:1}}getCacheBuster(){return this.getLatest().__cacheBuster}getFields(){return this.getLatest().__fields}getTextContent(){return"Block Field"}isInline(){return!0}setFields(e,t){let l=this.getWritable();l.__fields=e,t||l.__cacheBuster++}updateDOM(){return!1}};function Se(s){return new x({fields:{...s,id:s?.id||new Be.default().toHexString()}})}var Fe=ye.lazy(()=>import("./componentInline-MIPTDFRK.js").then(s=>({default:s.InlineBlockComponent}))),I=class extends x{static clone(e){return super.clone(e)}static getType(){return super.getType()}static importJSON(e){return De(e.fields)}decorate(e,t){return Ce(Fe,{cacheBuster:this.getCacheBuster(),formData:this.getFields(),nodeKey:this.getKey()})}exportJSON(){return super.exportJSON()}};function De(s){return new I({fields:{...s,id:s?.id||new _e.default().toHexString()}})}function M(s){return s instanceof I}var f="inline-block",ue=Ie({initialState:!1}),pt=()=>O.use(ue),bt=s=>{let{cacheBuster:e,formData:t,nodeKey:l}=s,[p]=ve(),c=Ne(),{i18n:T,t:m}=ze(),{createdInlineBlock:H,fieldProps:{featureClientSchemaMap:de,initialLexicalFormState:me,schemaPath:V},setCreatedInlineBlock:W,uuid:fe}=se(),{fields:C}=Me(),{getFormState:_}=Ke(),pe=Je(),q=S(!1),[a,$]=O.useState(()=>me?.[t.id]?.formState),G=S(!1),Q=S(e);v(()=>{G.current?(Q.current!==e&&$(!1),Q.current=e):G.current=!0},[e]);let[P,U]=O.useState(a?._components?.customComponents?.BlockLabel),[X,Y]=O.useState(a?._components?.customComponents?.Block),Z=Pe({slug:`lexical-inlineBlocks-create-${fe}-${t.id}`,depth:pe}),{toggleDrawer:k}=ie(Z,!0),be=S(null),{id:y,collectionSlug:F,getDocPreferences:D,globalSlug:w}=Ae(),{config:ke}=je(),he=`${V}.lexical_internal_feature.blocks.lexical_inline_blocks.${t.blockType}`,h=de.blocks?.[he]?.[0],u=h.blockReferences?typeof h?.blockReferences?.[0]=="string"?ke.blocksMap[h?.blockReferences?.[0]]:h?.blockReferences?.[0]:h?.blocks?.[0],ee=u?.fields??[];v(()=>{!q.current&&H?.getKey()===l&&(ee.length>2&&k(),W?.(void 0),q.current=!0)},[ee.length,H,l,W,k]);let te=A(()=>{p.update(()=>{K(l)?.remove()})},[p,l]),g=u?.labels?.singular?ce(u?.labels.singular,T):u?.slug,L=S(new AbortController),B=`${V}.lexical_internal_feature.blocks.lexical_inline_blocks.${u?.slug}.fields`;v(()=>{let n=new AbortController;return t&&!a&&(async()=>{let{state:o}=await _({id:y,collectionSlug:F,data:t,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:z(C),globalSlug:w,initialBlockData:t,initialBlockFormState:t,operation:"update",readOnly:!c,renderAllFields:!0,schemaPath:B,signal:n.signal});if(o){let d=He(z(o),!0);p.update(()=>{let j=K(l);if(j&&M(j)){let le=d;le.blockType=t.blockType,j.setFields(le,!0)}}),$(o),U(o._components?.customComponents?.BlockLabel),Y(o._components?.customComponents?.Block)}})(),()=>{J(n)}},[_,p,l,c,B,y,t,a,F,w,D,C]);let ne=A(async({formState:n,submit:i})=>{J(L.current);let o=new AbortController;L.current=o;let{state:d}=await _({id:y,collectionSlug:F,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:z(C),formState:n,globalSlug:w,initialBlockFormState:n,operation:"update",readOnly:!c,renderAllFields:!!i,schemaPath:B,signal:o.signal});return d?(i&&(U(d._components?.customComponents?.BlockLabel),Y(d._components?.customComponents?.Block)),d):n},[_,y,F,D,C,w,c,B]);v(()=>{let n=(i,o)=>Object.keys(o).some(d=>o[d]&&i[d]!==o[d].value);return()=>{a&&n(t,a)&&$(!1),J(L.current)}},[t,a]);let ge=A((n,i)=>{i.blockType=t.blockType,p.update(()=>{let o=K(l);o&&M(o)&&o.setFields(i,!0)})},[p,l,t]),R=N(()=>()=>r(ae,{buttonStyle:"icon-label",className:`${f}__removeButton`,disabled:!c,icon:"x",onClick:n=>{n.preventDefault(),te()},round:!0,size:"small",tooltip:m("lexical:blocks:inlineBlocks:remove",{label:g})}),[g,c,te,m]),oe=N(()=>()=>r(ae,{buttonStyle:"icon-label",className:`${f}__editButton`,disabled:!c,el:"button",icon:"edit",onClick:()=>{k()},round:!0,size:"small",tooltip:m("lexical:blocks:inlineBlocks:edit",{label:g})}),[g,c,m,k]),E=N(()=>({children:n,className:i})=>r("div",{className:[f,f+"-"+t.blockType,i].filter(Boolean).join(" "),ref:be,children:n}),[t.blockType]),re=N(()=>P?()=>P:()=>r("div",{children:u?.labels?ce(u?.labels.singular,T):""}),[P,u?.labels,T]);return u?b($e,{beforeSubmit:[async({formState:n})=>await ne({formState:n,submit:!0})],disableValidationOnSubmit:!0,el:"div",fields:u?.fields,initialState:a||{},onChange:[ne],onSubmit:(n,i)=>{ge(n,i),k()},uuid:Ve(),children:[r(Te,{children:r(Oe,{className:"",slug:Z,title:m(`lexical:blocks:inlineBlocks:${t?.id?"edit":"create"}`,{label:g??m("lexical:blocks:inlineBlocks:label")}),children:a?b(we,{children:[r(Re,{fields:u?.fields,forceRender:!0,parentIndexPath:"",parentPath:"",parentSchemaPath:B,permissions:!0,readOnly:!c}),r(Le,{programmaticSubmit:!0,children:m("fields:saveChanges")})]}):null})}),X?r(ue,{value:{EditButton:oe,initialState:a,InlineBlockContainer:E,Label:re,nodeKey:l,RemoveButton:R},children:X}):b(E,{children:[a?r(re,{}):r(Ee,{height:"15px",width:"40px"}),c?b("div",{className:`${f}__actions`,children:[r(oe,{}),r(R,{})]}):null]})]}):b(E,{className:`${f}-not-found`,children:[b("span",{children:["Error: Block '",t.blockType,"' not found"]}),c?r("div",{className:`${f}__actions`,children:r(R,{})}):null]})};export{pt as a,bt as b,I as c,De as d,M as e};
//# sourceMappingURL=chunk-ADWHGDDR.js.map
