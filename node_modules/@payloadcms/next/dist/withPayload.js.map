{"version":3,"file":"withPayload.js","names":["withPayload","nextConfig","options","env","experimental","staleTimes","dynamic","console","warn","NEXT_PUBLIC_ENABLE_ROUTER_CACHE_REFRESH","process","PAYLOAD_PATCH_TURBOPACK_WARNINGS","turbopackWarningText","consoleWarn","args","includes","poweredByHeader","key","value","toReturn","outputFileTracingExcludes","outputFileTracingIncludes","headers","headersFromConfig","source","serverExternalPackages","NODE_ENV","devBundleServerPackages","webpack","webpackConfig","webpackOptions","incomingWebpackConfig","externals","ignoreWarnings","module","file","plugins","IgnorePlugin","resourceRegExp","resolve","alias","fallback","aws4","kerberos","snappy","basePath","NEXT_BASE_PATH"],"sources":["../src/withPayload.js"],"sourcesContent":["/**\n * @param {import('next').NextConfig} nextConfig\n * @param {Object} [options] - Optional configuration options\n * @param {boolean} [options.devBundleServerPackages] - Whether to bundle server packages in development mode. @default true\n *\n * @returns {import('next').NextConfig}\n * */\nexport const withPayload = (nextConfig = {}, options = {}) => {\n  const env = nextConfig?.env || {}\n\n  if (nextConfig.experimental?.staleTimes?.dynamic) {\n    console.warn(\n      'Payload detected a non-zero value for the `staleTimes.dynamic` option in your Next.js config. This will slow down page transitions and may cause stale data to load within the Admin panel. To clear this warning, remove the `staleTimes.dynamic` option from your Next.js config or set it to 0. In the future, Next.js may support scoping this option to specific routes.',\n    )\n    env.NEXT_PUBLIC_ENABLE_ROUTER_CACHE_REFRESH = 'true'\n  }\n\n  if (process.env.PAYLOAD_PATCH_TURBOPACK_WARNINGS !== 'false') {\n    const turbopackWarningText =\n      'Packages that should be external need to be installed in the project directory, so they can be resolved from the output files.\\nTry to install it into the project directory by running'\n\n    const consoleWarn = console.warn\n    console.warn = (...args) => {\n      // Force to disable serverExternalPackages warnings: https://github.com/vercel/next.js/issues/68805\n      if (\n        (typeof args[1] === 'string' && args[1].includes(turbopackWarningText)) ||\n        (typeof args[0] === 'string' && args[0].includes(turbopackWarningText))\n      ) {\n        return\n      }\n\n      consoleWarn(...args)\n    }\n  }\n\n  const poweredByHeader = {\n    key: 'X-Powered-By',\n    value: 'Next.js, Payload',\n  }\n\n  /**\n   * @type {import('next').NextConfig}\n   */\n  const toReturn = {\n    ...nextConfig,\n    env,\n    outputFileTracingExcludes: {\n      ...(nextConfig?.outputFileTracingExcludes || {}),\n      '**/*': [\n        ...(nextConfig?.outputFileTracingExcludes?.['**/*'] || []),\n        'drizzle-kit',\n        'drizzle-kit/api',\n      ],\n    },\n    outputFileTracingIncludes: {\n      ...(nextConfig?.outputFileTracingIncludes || {}),\n      '**/*': [...(nextConfig?.outputFileTracingIncludes?.['**/*'] || []), '@libsql/client'],\n    },\n    // We disable the poweredByHeader here because we add it manually in the headers function below\n    ...(nextConfig?.poweredByHeader !== false ? { poweredByHeader: false } : {}),\n    headers: async () => {\n      const headersFromConfig = 'headers' in nextConfig ? await nextConfig.headers() : []\n\n      return [\n        ...(headersFromConfig || []),\n        {\n          source: '/:path*',\n          headers: [\n            {\n              key: 'Accept-CH',\n              value: 'Sec-CH-Prefers-Color-Scheme',\n            },\n            {\n              key: 'Vary',\n              value: 'Sec-CH-Prefers-Color-Scheme',\n            },\n            {\n              key: 'Critical-CH',\n              value: 'Sec-CH-Prefers-Color-Scheme',\n            },\n            ...(nextConfig?.poweredByHeader !== false ? [poweredByHeader] : []),\n          ],\n        },\n      ]\n    },\n    serverExternalPackages: [\n      ...(nextConfig?.serverExternalPackages || []),\n      'drizzle-kit',\n      'drizzle-kit/api',\n      'pino',\n      'libsql',\n      'pino-pretty',\n      'graphql',\n      // Do not bundle server-only packages during dev to improve compile speed\n      ...(process.env.NODE_ENV === 'development' && options.devBundleServerPackages === false\n        ? [\n            'payload',\n            '@payloadcms/db-mongodb',\n            '@payloadcms/db-postgres',\n            '@payloadcms/db-sqlite',\n            '@payloadcms/db-vercel-postgres',\n            '@payloadcms/drizzle',\n            '@payloadcms/email-nodemailer',\n            '@payloadcms/email-resend',\n            '@payloadcms/graphql',\n            '@payloadcms/payload-cloud',\n            '@payloadcms/plugin-redirects',\n            // TODO: Add the following packages, excluding their /client subpath exports, once Next.js supports it\n            //'@payloadcms/plugin-cloud-storage',\n            //'@payloadcms/plugin-sentry',\n            //'@payloadcms/plugin-stripe',\n            // @payloadcms/richtext-lexical\n            //'@payloadcms/storage-azure',\n            //'@payloadcms/storage-gcs',\n            //'@payloadcms/storage-s3',\n            //'@payloadcms/storage-uploadthing',\n            //'@payloadcms/storage-vercel-blob',\n          ]\n        : []),\n    ],\n    webpack: (webpackConfig, webpackOptions) => {\n      const incomingWebpackConfig =\n        typeof nextConfig.webpack === 'function'\n          ? nextConfig.webpack(webpackConfig, webpackOptions)\n          : webpackConfig\n\n      return {\n        ...incomingWebpackConfig,\n        externals: [\n          ...(incomingWebpackConfig?.externals || []),\n          'drizzle-kit',\n          'drizzle-kit/api',\n          'sharp',\n          'libsql',\n          'require-in-the-middle',\n        ],\n        ignoreWarnings: [\n          ...(incomingWebpackConfig?.ignoreWarnings || []),\n          { module: /node_modules\\/mongodb\\/lib\\/utils\\.js/ },\n          { file: /node_modules\\/mongodb\\/lib\\/utils\\.js/ },\n          { module: /node_modules\\/mongodb\\/lib\\/bson\\.js/ },\n          { file: /node_modules\\/mongodb\\/lib\\/bson\\.js/ },\n        ],\n        plugins: [\n          ...(incomingWebpackConfig?.plugins || []),\n          // Fix cloudflare:sockets error: https://github.com/vercel/next.js/discussions/50177\n          new webpackOptions.webpack.IgnorePlugin({\n            resourceRegExp: /^pg-native$|^cloudflare:sockets$/,\n          }),\n        ],\n        resolve: {\n          ...(incomingWebpackConfig?.resolve || {}),\n          alias: {\n            ...(incomingWebpackConfig?.resolve?.alias || {}),\n          },\n          fallback: {\n            ...(incomingWebpackConfig?.resolve?.fallback || {}),\n            '@aws-sdk/credential-providers': false,\n            '@mongodb-js/zstd': false,\n            aws4: false,\n            kerberos: false,\n            'mongodb-client-encryption': false,\n            snappy: false,\n            'supports-color': false,\n            'yocto-queue': false,\n          },\n        },\n      }\n    },\n  }\n\n  if (nextConfig.basePath) {\n    toReturn.env.NEXT_BASE_PATH = nextConfig.basePath\n  }\n\n  return toReturn\n}\n\nexport default withPayload\n"],"mappings":"AAAA;;;;;;KAOA,OAAO,MAAMA,WAAA,GAAcA,CAACC,UAAA,GAAa,CAAC,CAAC,EAAEC,OAAA,GAAU,CAAC,CAAC;EACvD,MAAMC,GAAA,GAAMF,UAAA,EAAYE,GAAA,IAAO,CAAC;EAEhC,IAAIF,UAAA,CAAWG,YAAY,EAAEC,UAAA,EAAYC,OAAA,EAAS;IAChDC,OAAA,CAAQC,IAAI,CACV;IAEFL,GAAA,CAAIM,uCAAuC,GAAG;EAChD;EAEA,IAAIC,OAAA,CAAQP,GAAG,CAACQ,gCAAgC,KAAK,SAAS;IAC5D,MAAMC,oBAAA,GACJ;IAEF,MAAMC,WAAA,GAAcN,OAAA,CAAQC,IAAI;IAChCD,OAAA,CAAQC,IAAI,GAAG,CAAC,GAAGM,IAAA;MACjB;MACA,IACE,OAAQA,IAAI,CAAC,EAAE,KAAK,YAAYA,IAAI,CAAC,EAAE,CAACC,QAAQ,CAACH,oBAAA,KAChD,OAAOE,IAAI,CAAC,EAAE,KAAK,YAAYA,IAAI,CAAC,EAAE,CAACC,QAAQ,CAACH,oBAAA,GACjD;QACA;MACF;MAEAC,WAAA,IAAeC,IAAA;IACjB;EACF;EAEA,MAAME,eAAA,GAAkB;IACtBC,GAAA,EAAK;IACLC,KAAA,EAAO;EACT;EAEA;;;EAGA,MAAMC,QAAA,GAAW;IACf,GAAGlB,UAAU;IACbE,GAAA;IACAiB,yBAAA,EAA2B;MACzB,IAAInB,UAAA,EAAYmB,yBAAA,IAA6B,CAAC,CAAC;MAC/C,QAAQ,C,IACFnB,UAAA,EAAYmB,yBAAA,GAA4B,OAAO,IAAI,EAAE,GACzD,eACA;IAEJ;IACAC,yBAAA,EAA2B;MACzB,IAAIpB,UAAA,EAAYoB,yBAAA,IAA6B,CAAC,CAAC;MAC/C,QAAQ,C,IAAKpB,UAAA,EAAYoB,yBAAA,GAA4B,OAAO,IAAI,EAAE,GAAG;IACvE;IACA;IACA,IAAIpB,UAAA,EAAYe,eAAA,KAAoB,QAAQ;MAAEA,eAAA,EAAiB;IAAM,IAAI,CAAC,CAAC;IAC3EM,OAAA,EAAS,MAAAA,CAAA;MACP,MAAMC,iBAAA,GAAoB,aAAatB,UAAA,GAAa,MAAMA,UAAA,CAAWqB,OAAO,KAAK,EAAE;MAEnF,OAAO,C,IACDC,iBAAA,IAAqB,EAAE,GAC3B;QACEC,MAAA,EAAQ;QACRF,OAAA,EAAS,CACP;UACEL,GAAA,EAAK;UACLC,KAAA,EAAO;QACT,GACA;UACED,GAAA,EAAK;UACLC,KAAA,EAAO;QACT,GACA;UACED,GAAA,EAAK;UACLC,KAAA,EAAO;QACT,G,IACIjB,UAAA,EAAYe,eAAA,KAAoB,QAAQ,CAACA,eAAA,CAAgB,GAAG,EAAE;MAEtE,EACD;IACH;IACAS,sBAAA,EAAwB,C,IAClBxB,UAAA,EAAYwB,sBAAA,IAA0B,EAAE,GAC5C,eACA,mBACA,QACA,UACA,eACA;IACA;QACIf,OAAA,CAAQP,GAAG,CAACuB,QAAQ,KAAK,iBAAiBxB,OAAA,CAAQyB,uBAAuB,KAAK,QAC9E,CACE,WACA,0BACA,2BACA,yBACA,kCACA,uBACA,gCACA,4BACA,uBACA,6BACA,+BAWD,GACD,EAAE,EACP;IACDC,OAAA,EAASA,CAACC,aAAA,EAAeC,cAAA;MACvB,MAAMC,qBAAA,GACJ,OAAO9B,UAAA,CAAW2B,OAAO,KAAK,aAC1B3B,UAAA,CAAW2B,OAAO,CAACC,aAAA,EAAeC,cAAA,IAClCD,aAAA;MAEN,OAAO;QACL,GAAGE,qBAAqB;QACxBC,SAAA,EAAW,C,IACLD,qBAAA,EAAuBC,SAAA,IAAa,EAAE,GAC1C,eACA,mBACA,SACA,UACA,wBACD;QACDC,cAAA,EAAgB,C,IACVF,qBAAA,EAAuBE,cAAA,IAAkB,EAAE,GAC/C;UAAEC,MAAA,EAAQ;QAAwC,GAClD;UAAEC,IAAA,EAAM;QAAwC,GAChD;UAAED,MAAA,EAAQ;QAAuC,GACjD;UAAEC,IAAA,EAAM;QAAuC,EAChD;QACDC,OAAA,EAAS,C,IACHL,qBAAA,EAAuBK,OAAA,IAAW,EAAE;QACxC;QACA,IAAIN,cAAA,CAAeF,OAAO,CAACS,YAAY,CAAC;UACtCC,cAAA,EAAgB;QAClB,GACD;QACDC,OAAA,EAAS;UACP,IAAIR,qBAAA,EAAuBQ,OAAA,IAAW,CAAC,CAAC;UACxCC,KAAA,EAAO;YACL,IAAIT,qBAAA,EAAuBQ,OAAA,EAASC,KAAA,IAAS,CAAC,CAAC;UACjD;UACAC,QAAA,EAAU;YACR,IAAIV,qBAAA,EAAuBQ,OAAA,EAASE,QAAA,IAAY,CAAC,CAAC;YAClD,iCAAiC;YACjC,oBAAoB;YACpBC,IAAA,EAAM;YACNC,QAAA,EAAU;YACV,6BAA6B;YAC7BC,MAAA,EAAQ;YACR,kBAAkB;YAClB,eAAe;UACjB;QACF;MACF;IACF;EACF;EAEA,IAAI3C,UAAA,CAAW4C,QAAQ,EAAE;IACvB1B,QAAA,CAAShB,GAAG,CAAC2C,cAAc,GAAG7C,UAAA,CAAW4C,QAAQ;EACnD;EAEA,OAAO1B,QAAA;AACT;AAEA,eAAenB,WAAA","ignoreList":[]}