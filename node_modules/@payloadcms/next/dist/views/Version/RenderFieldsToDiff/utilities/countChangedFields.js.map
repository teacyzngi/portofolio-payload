{"version":3,"file":"countChangedFields.js","names":["fieldShouldBeLocalized","groupHasName","fieldHasChanges","getFieldsForRowComparison","countChangedFields","config","fields","locales","parentIsLocalized","valueFrom","valueTo","count","forEach","field","name","fieldType","type","locale","valueFromRows","valueToRows","countChangedFieldsInRows","localized","tabs","tab","_exhaustiveCheck","Error","String","i","valueFromRow","valueToRow","rowFields","baseVersionField","path","schemaPath","row"],"sources":["../../../../../src/views/Version/RenderFieldsToDiff/utilities/countChangedFields.ts"],"sourcesContent":["import type { ArrayFieldClient, BlocksFieldClient, ClientConfig, ClientField } from 'payload'\n\nimport { fieldShouldBeLocalized, groupHasName } from 'payload/shared'\n\nimport { fieldHasChanges } from './fieldHasChanges.js'\nimport { getFieldsForRowComparison } from './getFieldsForRowComparison.js'\n\ntype Args = {\n  config: ClientConfig\n  fields: ClientField[]\n  locales: string[] | undefined\n  parentIsLocalized: boolean\n  valueFrom: unknown\n  valueTo: unknown\n}\n\n/**\n * Recursively counts the number of changed fields between comparison and\n * version data for a given set of fields.\n */\nexport function countChangedFields({\n  config,\n  fields,\n  locales,\n  parentIsLocalized,\n  valueFrom,\n  valueTo,\n}: Args) {\n  let count = 0\n\n  fields.forEach((field) => {\n    // Don't count the id field since it is not displayed in the UI\n    if ('name' in field && field.name === 'id') {\n      return\n    }\n    const fieldType = field.type\n    switch (fieldType) {\n      // Iterable fields are arrays and blocks fields. We iterate over each row and\n      // count the number of changed fields in each.\n      case 'array':\n      case 'blocks': {\n        if (locales && fieldShouldBeLocalized({ field, parentIsLocalized })) {\n          locales.forEach((locale) => {\n            const valueFromRows = valueFrom?.[field.name]?.[locale] ?? []\n            const valueToRows = valueTo?.[field.name]?.[locale] ?? []\n            count += countChangedFieldsInRows({\n              config,\n              field,\n              locales,\n              parentIsLocalized: parentIsLocalized || field.localized,\n              valueFromRows,\n              valueToRows,\n            })\n          })\n        } else {\n          const valueFromRows = valueFrom?.[field.name] ?? []\n          const valueToRows = valueTo?.[field.name] ?? []\n          count += countChangedFieldsInRows({\n            config,\n            field,\n            locales,\n            parentIsLocalized: parentIsLocalized || field.localized,\n            valueFromRows,\n            valueToRows,\n          })\n        }\n        break\n      }\n\n      // Regular fields without nested fields.\n      case 'checkbox':\n      case 'code':\n      case 'date':\n      case 'email':\n      case 'join':\n      case 'json':\n      case 'number':\n      case 'point':\n      case 'radio':\n      case 'relationship':\n      case 'richText':\n      case 'select':\n      case 'text':\n      case 'textarea':\n      case 'upload': {\n        // Fields that have a name and contain data. We can just check if the data has changed.\n        if (locales && fieldShouldBeLocalized({ field, parentIsLocalized })) {\n          locales.forEach((locale) => {\n            if (\n              fieldHasChanges(valueTo?.[field.name]?.[locale], valueFrom?.[field.name]?.[locale])\n            ) {\n              count++\n            }\n          })\n        } else if (fieldHasChanges(valueTo?.[field.name], valueFrom?.[field.name])) {\n          count++\n        }\n        break\n      }\n      // Fields that have nested fields, but don't nest their fields' data.\n      case 'collapsible':\n      case 'row': {\n        count += countChangedFields({\n          config,\n          fields: field.fields,\n          locales,\n          parentIsLocalized: parentIsLocalized || field.localized,\n          valueFrom,\n          valueTo,\n        })\n\n        break\n      }\n\n      // Fields that have nested fields and nest their fields' data.\n      case 'group': {\n        if (groupHasName(field)) {\n          if (locales && fieldShouldBeLocalized({ field, parentIsLocalized })) {\n            locales.forEach((locale) => {\n              count += countChangedFields({\n                config,\n                fields: field.fields,\n                locales,\n                parentIsLocalized: parentIsLocalized || field.localized,\n                valueFrom: valueFrom?.[field.name]?.[locale],\n                valueTo: valueTo?.[field.name]?.[locale],\n              })\n            })\n          } else {\n            count += countChangedFields({\n              config,\n              fields: field.fields,\n              locales,\n              parentIsLocalized: parentIsLocalized || field.localized,\n              valueFrom: valueFrom?.[field.name],\n              valueTo: valueTo?.[field.name],\n            })\n          }\n        } else {\n          // Unnamed group field: data is NOT nested under `field.name`\n          count += countChangedFields({\n            config,\n            fields: field.fields,\n            locales,\n            parentIsLocalized: parentIsLocalized || field.localized,\n            valueFrom,\n            valueTo,\n          })\n        }\n        break\n      }\n\n      // Each tab in a tabs field has nested fields. The fields data may be\n      // nested or not depending on the existence of a name property.\n      case 'tabs': {\n        field.tabs.forEach((tab) => {\n          if ('name' in tab && locales && tab.localized) {\n            // Named localized tab\n            locales.forEach((locale) => {\n              count += countChangedFields({\n                config,\n                fields: tab.fields,\n                locales,\n                parentIsLocalized: parentIsLocalized || tab.localized,\n                valueFrom: valueFrom?.[tab.name]?.[locale],\n                valueTo: valueTo?.[tab.name]?.[locale],\n              })\n            })\n          } else if ('name' in tab) {\n            // Named tab\n            count += countChangedFields({\n              config,\n              fields: tab.fields,\n              locales,\n              parentIsLocalized: parentIsLocalized || tab.localized,\n              valueFrom: valueFrom?.[tab.name],\n              valueTo: valueTo?.[tab.name],\n            })\n          } else {\n            // Unnamed tab\n            count += countChangedFields({\n              config,\n              fields: tab.fields,\n              locales,\n              parentIsLocalized: parentIsLocalized || tab.localized,\n              valueFrom,\n              valueTo,\n            })\n          }\n        })\n        break\n      }\n\n      // UI fields don't have data and are not displayed in the version view\n      // so we can ignore them.\n      case 'ui': {\n        break\n      }\n\n      default: {\n        const _exhaustiveCheck: never = fieldType\n        throw new Error(`Unexpected field.type in countChangedFields : ${String(fieldType)}`)\n      }\n    }\n  })\n\n  return count\n}\n\ntype countChangedFieldsInRowsArgs = {\n  config: ClientConfig\n  field: ArrayFieldClient | BlocksFieldClient\n  locales: string[] | undefined\n  parentIsLocalized: boolean\n  valueFromRows: unknown[]\n  valueToRows: unknown[]\n}\n\nexport function countChangedFieldsInRows({\n  config,\n  field,\n  locales,\n  parentIsLocalized,\n  valueFromRows = [],\n  valueToRows = [],\n}: countChangedFieldsInRowsArgs) {\n  let count = 0\n  let i = 0\n\n  while (valueFromRows[i] || valueToRows[i]) {\n    const valueFromRow = valueFromRows?.[i] || {}\n    const valueToRow = valueToRows?.[i] || {}\n\n    const { fields: rowFields } = getFieldsForRowComparison({\n      baseVersionField: { type: 'text', fields: [], path: '', schemaPath: '' }, // Doesn't matter, as we don't need the versionFields output here\n      config,\n      field,\n      row: i,\n      valueFromRow,\n      valueToRow,\n    })\n\n    count += countChangedFields({\n      config,\n      fields: rowFields,\n      locales,\n      parentIsLocalized: parentIsLocalized || field.localized,\n      valueFrom: valueFromRow,\n      valueTo: valueToRow,\n    })\n\n    i++\n  }\n  return count\n}\n"],"mappings":"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","ignoreList":[]}