{"version":3,"file":"handleServerFunction.js","names":["getClientConfig","headers","getHeaders","canAccessAdmin","getAccessResults","isEntityHidden","parseCookies","renderListView","renderListHandler","args","collectionSlug","disableActions","disableBulkDelete","disableBulkEdit","disableQueryPresets","drawerSlug","enableRowSelections","overrideEntityVisibility","query","redirectAfterDelete","redirectAfterDuplicate","req","i18n","payload","config","user","cookies","clientConfig","importMap","preferencesKey","preferences","find","collection","depth","limit","where","and","key","equals","id","then","res","docs","value","visibleEntities","collections","map","slug","admin","hidden","filter","Boolean","globals","permissions","List","initPageResult","collectionConfig","globalConfig","global","languageOptions","undefined","translations","params","segments","searchParams","viewType"],"sources":["../../../src/views/List/handleServerFunction.tsx"],"sourcesContent":["import type { CollectionPreferences, ListQuery, ServerFunction, VisibleEntities } from 'payload'\n\nimport { getClientConfig } from '@payloadcms/ui/utilities/getClientConfig'\nimport { headers as getHeaders } from 'next/headers.js'\nimport { canAccessAdmin, getAccessResults, isEntityHidden, parseCookies } from 'payload'\n\nimport { renderListView } from './index.js'\n\ntype RenderListResult = {\n  List: React.ReactNode\n  preferences: CollectionPreferences\n}\n\nexport const renderListHandler: ServerFunction<\n  {\n    collectionSlug: string\n    disableActions?: boolean\n    disableBulkDelete?: boolean\n    disableBulkEdit?: boolean\n    disableQueryPresets?: boolean\n    documentDrawerSlug: string\n    drawerSlug?: string\n    enableRowSelections: boolean\n    overrideEntityVisibility?: boolean\n    query: ListQuery\n    redirectAfterDelete: boolean\n    redirectAfterDuplicate: boolean\n  },\n  Promise<RenderListResult>\n> = async (args) => {\n  const {\n    collectionSlug,\n    disableActions,\n    disableBulkDelete,\n    disableBulkEdit,\n    disableQueryPresets,\n    drawerSlug,\n    enableRowSelections,\n    overrideEntityVisibility,\n    query,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    req,\n    req: {\n      i18n,\n      payload,\n      payload: { config },\n      user,\n    },\n  } = args\n\n  const headers = await getHeaders()\n\n  const cookies = parseCookies(headers)\n\n  await canAccessAdmin({ req })\n\n  const clientConfig = getClientConfig({\n    config,\n    i18n,\n    importMap: payload.importMap,\n    user,\n  })\n\n  const preferencesKey = `collection-${collectionSlug}`\n\n  const preferences = await payload\n    .find({\n      collection: 'payload-preferences',\n      depth: 0,\n      limit: 1,\n      where: {\n        and: [\n          {\n            key: {\n              equals: preferencesKey,\n            },\n          },\n          {\n            'user.relationTo': {\n              equals: user.collection,\n            },\n          },\n          {\n            'user.value': {\n              equals: user.id,\n            },\n          },\n        ],\n      },\n    })\n    .then((res) => res.docs[0]?.value as CollectionPreferences)\n\n  const visibleEntities: VisibleEntities = {\n    collections: payload.config.collections\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n    globals: payload.config.globals\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n  }\n\n  const permissions = await getAccessResults({\n    req,\n  })\n\n  const { List } = await renderListView({\n    clientConfig,\n    disableActions,\n    disableBulkDelete,\n    disableBulkEdit,\n    disableQueryPresets,\n    drawerSlug,\n    enableRowSelections,\n    i18n,\n    importMap: payload.importMap,\n    initPageResult: {\n      collectionConfig: payload?.collections?.[collectionSlug]?.config,\n      cookies,\n      globalConfig: payload.config.globals.find((global) => global.slug === collectionSlug),\n      languageOptions: undefined, // TODO\n      permissions,\n      req,\n      translations: undefined, // TODO\n      visibleEntities,\n    },\n    overrideEntityVisibility,\n    params: {\n      segments: ['collections', collectionSlug],\n    },\n    payload,\n    query,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    searchParams: {},\n    viewType: 'list',\n  })\n\n  return {\n    List,\n    preferences,\n  }\n}\n"],"mappings":"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","ignoreList":[]}