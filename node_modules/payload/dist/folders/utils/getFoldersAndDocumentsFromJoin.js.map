{"version":3,"sources":["../../../src/folders/utils/getFoldersAndDocumentsFromJoin.ts"],"sourcesContent":["import type { PaginatedDocs } from '../../database/types.js'\nimport type { CollectionSlug } from '../../index.js'\nimport type { Document, PayloadRequest, Where } from '../../types/index.js'\nimport type { FolderOrDocument } from '../types.js'\n\nimport { APIError } from '../../errors/APIError.js'\nimport { combineWhereConstraints } from '../../utilities/combineWhereConstraints.js'\nimport { formatFolderOrDocumentItem } from './formatFolderOrDocumentItem.js'\n\ntype QueryDocumentsAndFoldersResults = {\n  documents: FolderOrDocument[]\n  folderAssignedCollections: CollectionSlug[]\n  subfolders: FolderOrDocument[]\n}\ntype QueryDocumentsAndFoldersArgs = {\n  /**\n   * Optional where clause to filter documents by\n   * @default undefined\n   */\n  documentWhere?: Where\n  /** Optional where clause to filter subfolders by\n   * @default undefined\n   */\n  folderWhere?: Where\n  parentFolderID: number | string\n  req: PayloadRequest\n}\nexport async function queryDocumentsAndFoldersFromJoin({\n  documentWhere,\n  folderWhere,\n  parentFolderID,\n  req,\n}: QueryDocumentsAndFoldersArgs): Promise<QueryDocumentsAndFoldersResults> {\n  const { payload, user } = req\n\n  if (payload.config.folders === false) {\n    throw new APIError('Folders are not enabled', 500)\n  }\n\n  const subfolderDoc = (await payload.find({\n    collection: payload.config.folders.slug,\n    depth: 1,\n    joins: {\n      documentsAndFolders: {\n        limit: 100_000_000,\n        sort: 'name',\n        where: combineWhereConstraints([folderWhere, documentWhere], 'or'),\n      },\n    },\n    limit: 1,\n    overrideAccess: false,\n    req,\n    select: {\n      documentsAndFolders: true,\n      folderType: true,\n    },\n    user,\n    where: {\n      id: {\n        equals: parentFolderID,\n      },\n    },\n  })) as PaginatedDocs<Document>\n\n  const childrenDocs = subfolderDoc?.docs[0]?.documentsAndFolders?.docs || []\n\n  const results: QueryDocumentsAndFoldersResults = childrenDocs.reduce(\n    (acc: QueryDocumentsAndFoldersResults, doc: Document) => {\n      if (!payload.config.folders) {\n        return acc\n      }\n      const { relationTo, value } = doc\n      const item = formatFolderOrDocumentItem({\n        folderFieldName: payload.config.folders.fieldName,\n        isUpload: Boolean(payload.collections[relationTo]!.config.upload),\n        relationTo,\n        useAsTitle: payload.collections[relationTo]!.config.admin?.useAsTitle,\n        value,\n      })\n\n      if (relationTo === payload.config.folders.slug) {\n        acc.subfolders.push(item)\n      } else {\n        acc.documents.push(item)\n      }\n\n      return acc\n    },\n    {\n      documents: [],\n      subfolders: [],\n    },\n  )\n\n  return {\n    documents: results.documents,\n    folderAssignedCollections: subfolderDoc?.docs[0]?.folderType || [],\n    subfolders: results.subfolders,\n  }\n}\n"],"names":["APIError","combineWhereConstraints","formatFolderOrDocumentItem","queryDocumentsAndFoldersFromJoin","documentWhere","folderWhere","parentFolderID","req","payload","user","config","folders","subfolderDoc","find","collection","slug","depth","joins","documentsAndFolders","limit","sort","where","overrideAccess","select","folderType","id","equals","childrenDocs","docs","results","reduce","acc","doc","relationTo","value","item","folderFieldName","fieldName","isUpload","Boolean","collections","upload","useAsTitle","admin","subfolders","push","documents","folderAssignedCollections"],"mappings":"AAKA,SAASA,QAAQ,QAAQ,2BAA0B;AACnD,SAASC,uBAAuB,QAAQ,6CAA4C;AACpF,SAASC,0BAA0B,QAAQ,kCAAiC;AAoB5E,OAAO,eAAeC,iCAAiC,EACrDC,aAAa,EACbC,WAAW,EACXC,cAAc,EACdC,GAAG,EAC0B;IAC7B,MAAM,EAAEC,OAAO,EAAEC,IAAI,EAAE,GAAGF;IAE1B,IAAIC,QAAQE,MAAM,CAACC,OAAO,KAAK,OAAO;QACpC,MAAM,IAAIX,SAAS,2BAA2B;IAChD;IAEA,MAAMY,eAAgB,MAAMJ,QAAQK,IAAI,CAAC;QACvCC,YAAYN,QAAQE,MAAM,CAACC,OAAO,CAACI,IAAI;QACvCC,OAAO;QACPC,OAAO;YACLC,qBAAqB;gBACnBC,OAAO;gBACPC,MAAM;gBACNC,OAAOpB,wBAAwB;oBAACI;oBAAaD;iBAAc,EAAE;YAC/D;QACF;QACAe,OAAO;QACPG,gBAAgB;QAChBf;QACAgB,QAAQ;YACNL,qBAAqB;YACrBM,YAAY;QACd;QACAf;QACAY,OAAO;YACLI,IAAI;gBACFC,QAAQpB;YACV;QACF;IACF;IAEA,MAAMqB,eAAef,cAAcgB,IAAI,CAAC,EAAE,EAAEV,qBAAqBU,QAAQ,EAAE;IAE3E,MAAMC,UAA2CF,aAAaG,MAAM,CAClE,CAACC,KAAsCC;QACrC,IAAI,CAACxB,QAAQE,MAAM,CAACC,OAAO,EAAE;YAC3B,OAAOoB;QACT;QACA,MAAM,EAAEE,UAAU,EAAEC,KAAK,EAAE,GAAGF;QAC9B,MAAMG,OAAOjC,2BAA2B;YACtCkC,iBAAiB5B,QAAQE,MAAM,CAACC,OAAO,CAAC0B,SAAS;YACjDC,UAAUC,QAAQ/B,QAAQgC,WAAW,CAACP,WAAW,CAAEvB,MAAM,CAAC+B,MAAM;YAChER;YACAS,YAAYlC,QAAQgC,WAAW,CAACP,WAAW,CAAEvB,MAAM,CAACiC,KAAK,EAAED;YAC3DR;QACF;QAEA,IAAID,eAAezB,QAAQE,MAAM,CAACC,OAAO,CAACI,IAAI,EAAE;YAC9CgB,IAAIa,UAAU,CAACC,IAAI,CAACV;QACtB,OAAO;YACLJ,IAAIe,SAAS,CAACD,IAAI,CAACV;QACrB;QAEA,OAAOJ;IACT,GACA;QACEe,WAAW,EAAE;QACbF,YAAY,EAAE;IAChB;IAGF,OAAO;QACLE,WAAWjB,QAAQiB,SAAS;QAC5BC,2BAA2BnC,cAAcgB,IAAI,CAAC,EAAE,EAAEJ,cAAc,EAAE;QAClEoB,YAAYf,QAAQe,UAAU;IAChC;AACF"}