{"version":3,"sources":["../../src/uploads/getExternalFile.ts"],"sourcesContent":["import type { PayloadRequest } from '../types/index.js'\nimport type { File, FileData, UploadConfig } from './types.js'\n\nimport { APIError } from '../errors/index.js'\nimport { isURLAllowed } from '../utilities/isURLAllowed.js'\nimport { safeFetch } from './safeFetch.js'\n\ntype Args = {\n  data: FileData\n  req: PayloadRequest\n  uploadConfig: UploadConfig\n}\nexport const getExternalFile = async ({ data, req, uploadConfig }: Args): Promise<File> => {\n  const { filename, url } = data\n\n  let trimAuthCookies = true\n  if (typeof url === 'string') {\n    let fileURL = url\n    if (!url.startsWith('http')) {\n      // URL points to the same server - we can send any cookies safely to our server.\n      trimAuthCookies = false\n      const baseUrl = req.headers.get('origin') || `${req.protocol}://${req.headers.get('host')}`\n      fileURL = `${baseUrl}${url}`\n    }\n\n    let cookies = (req.headers.get('cookie') ?? '').split(';')\n\n    if (trimAuthCookies) {\n      cookies = cookies.filter(\n        (cookie) => !cookie.trim().startsWith(req.payload.config.cookiePrefix),\n      )\n    }\n\n    const headers = uploadConfig.externalFileHeaderFilter\n      ? uploadConfig.externalFileHeaderFilter(Object.fromEntries(new Headers(req.headers)))\n      : {\n          cookie: cookies.join(';'),\n        }\n\n    // Check if URL is allowed because of skipSafeFetch allowList\n    const skipSafeFetch: boolean =\n      uploadConfig.skipSafeFetch === true\n        ? uploadConfig.skipSafeFetch\n        : Array.isArray(uploadConfig.skipSafeFetch) &&\n          isURLAllowed(fileURL, uploadConfig.skipSafeFetch)\n\n    // Check if URL is allowed because of pasteURL allowList\n    const isAllowedPasteUrl: boolean | undefined =\n      uploadConfig.pasteURL &&\n      uploadConfig.pasteURL.allowList &&\n      isURLAllowed(fileURL, uploadConfig.pasteURL.allowList)\n\n    let res\n    if (skipSafeFetch || isAllowedPasteUrl) {\n      // Allowed\n      res = await fetch(fileURL, {\n        credentials: 'include',\n        headers,\n        method: 'GET',\n      })\n    } else {\n      // Default\n      res = await safeFetch(fileURL, {\n        credentials: 'include',\n        headers,\n        method: 'GET',\n      })\n    }\n\n    if (!res.ok) {\n      throw new APIError(`Failed to fetch file from ${fileURL}`, res.status)\n    }\n\n    const data = await res.arrayBuffer()\n\n    return {\n      name: filename,\n      data: Buffer.from(data),\n      mimetype: res.headers.get('content-type') || undefined!,\n      size: Number(res.headers.get('content-length')) || 0,\n    }\n  }\n\n  throw new APIError('Invalid file url', 400)\n}\n"],"names":["APIError","isURLAllowed","safeFetch","getExternalFile","data","req","uploadConfig","filename","url","trimAuthCookies","fileURL","startsWith","baseUrl","headers","get","protocol","cookies","split","filter","cookie","trim","payload","config","cookiePrefix","externalFileHeaderFilter","Object","fromEntries","Headers","join","skipSafeFetch","Array","isArray","isAllowedPasteUrl","pasteURL","allowList","res","fetch","credentials","method","ok","status","arrayBuffer","name","Buffer","from","mimetype","undefined","size","Number"],"mappings":"AAGA,SAASA,QAAQ,QAAQ,qBAAoB;AAC7C,SAASC,YAAY,QAAQ,+BAA8B;AAC3D,SAASC,SAAS,QAAQ,iBAAgB;AAO1C,OAAO,MAAMC,kBAAkB,OAAO,EAAEC,IAAI,EAAEC,GAAG,EAAEC,YAAY,EAAQ;IACrE,MAAM,EAAEC,QAAQ,EAAEC,GAAG,EAAE,GAAGJ;IAE1B,IAAIK,kBAAkB;IACtB,IAAI,OAAOD,QAAQ,UAAU;QAC3B,IAAIE,UAAUF;QACd,IAAI,CAACA,IAAIG,UAAU,CAAC,SAAS;YAC3B,gFAAgF;YAChFF,kBAAkB;YAClB,MAAMG,UAAUP,IAAIQ,OAAO,CAACC,GAAG,CAAC,aAAa,GAAGT,IAAIU,QAAQ,CAAC,GAAG,EAAEV,IAAIQ,OAAO,CAACC,GAAG,CAAC,SAAS;YAC3FJ,UAAU,GAAGE,UAAUJ,KAAK;QAC9B;QAEA,IAAIQ,UAAU,AAACX,CAAAA,IAAIQ,OAAO,CAACC,GAAG,CAAC,aAAa,EAAC,EAAGG,KAAK,CAAC;QAEtD,IAAIR,iBAAiB;YACnBO,UAAUA,QAAQE,MAAM,CACtB,CAACC,SAAW,CAACA,OAAOC,IAAI,GAAGT,UAAU,CAACN,IAAIgB,OAAO,CAACC,MAAM,CAACC,YAAY;QAEzE;QAEA,MAAMV,UAAUP,aAAakB,wBAAwB,GACjDlB,aAAakB,wBAAwB,CAACC,OAAOC,WAAW,CAAC,IAAIC,QAAQtB,IAAIQ,OAAO,MAChF;YACEM,QAAQH,QAAQY,IAAI,CAAC;QACvB;QAEJ,6DAA6D;QAC7D,MAAMC,gBACJvB,aAAauB,aAAa,KAAK,OAC3BvB,aAAauB,aAAa,GAC1BC,MAAMC,OAAO,CAACzB,aAAauB,aAAa,KACxC5B,aAAaS,SAASJ,aAAauB,aAAa;QAEtD,wDAAwD;QACxD,MAAMG,oBACJ1B,aAAa2B,QAAQ,IACrB3B,aAAa2B,QAAQ,CAACC,SAAS,IAC/BjC,aAAaS,SAASJ,aAAa2B,QAAQ,CAACC,SAAS;QAEvD,IAAIC;QACJ,IAAIN,iBAAiBG,mBAAmB;YACtC,UAAU;YACVG,MAAM,MAAMC,MAAM1B,SAAS;gBACzB2B,aAAa;gBACbxB;gBACAyB,QAAQ;YACV;QACF,OAAO;YACL,UAAU;YACVH,MAAM,MAAMjC,UAAUQ,SAAS;gBAC7B2B,aAAa;gBACbxB;gBACAyB,QAAQ;YACV;QACF;QAEA,IAAI,CAACH,IAAII,EAAE,EAAE;YACX,MAAM,IAAIvC,SAAS,CAAC,0BAA0B,EAAEU,SAAS,EAAEyB,IAAIK,MAAM;QACvE;QAEA,MAAMpC,OAAO,MAAM+B,IAAIM,WAAW;QAElC,OAAO;YACLC,MAAMnC;YACNH,MAAMuC,OAAOC,IAAI,CAACxC;YAClByC,UAAUV,IAAItB,OAAO,CAACC,GAAG,CAAC,mBAAmBgC;YAC7CC,MAAMC,OAAOb,IAAItB,OAAO,CAACC,GAAG,CAAC,sBAAsB;QACrD;IACF;IAEA,MAAM,IAAId,SAAS,oBAAoB;AACzC,EAAC"}