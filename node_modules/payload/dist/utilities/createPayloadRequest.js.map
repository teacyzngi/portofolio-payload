{"version":3,"sources":["../../src/utilities/createPayloadRequest.ts"],"sourcesContent":["import { initI18n } from '@payloadcms/translations'\nimport * as qs from 'qs-esm'\n\nimport type { SanitizedConfig } from '../config/types.js'\nimport type { CustomPayloadRequestProperties, PayloadRequest } from '../types/index.js'\n\nimport { executeAuthStrategies } from '../auth/executeAuthStrategies.js'\nimport { getDataLoader } from '../collections/dataloader.js'\nimport { getPayload } from '../index.js'\nimport { sanitizeLocales } from './addLocalesToRequest.js'\nimport { getRequestLanguage } from './getRequestLanguage.js'\nimport { parseCookies } from './parseCookies.js'\n\ntype Args = {\n  canSetHeaders?: boolean\n  config: Promise<SanitizedConfig> | SanitizedConfig\n  params?: {\n    collection: string\n  }\n  request: Request\n}\n\nexport const createPayloadRequest = async ({\n  canSetHeaders,\n  config: configPromise,\n  params,\n  request,\n}: Args): Promise<PayloadRequest> => {\n  const cookies = parseCookies(request.headers)\n  const payload = await getPayload({ config: configPromise, cron: true })\n\n  const { config } = payload\n  const localization = config.localization\n\n  const urlProperties = new URL(request.url)\n  const { pathname, searchParams } = urlProperties\n\n  const isGraphQL =\n    !config.graphQL.disable && pathname === `${config.routes.api}${config.routes.graphQL}`\n\n  const language = getRequestLanguage({\n    config,\n    cookies,\n    headers: request.headers,\n  })\n\n  const i18n = await initI18n({\n    config: config.i18n,\n    context: 'api',\n    language,\n  })\n\n  let locale = searchParams.get('locale')\n\n  const { search: queryToParse } = urlProperties\n\n  const query = queryToParse\n    ? qs.parse(queryToParse, {\n        arrayLimit: 1000,\n        depth: 10,\n        ignoreQueryPrefix: true,\n      })\n    : {}\n\n  const fallbackFromRequest =\n    (query.fallbackLocale as string | string[]) ||\n    searchParams.get('fallback-locale') ||\n    searchParams.get('fallbackLocale')\n\n  let fallbackLocale = fallbackFromRequest\n\n  if (localization) {\n    const locales = sanitizeLocales({\n      fallbackLocale: fallbackLocale!,\n      locale: locale!,\n      localization,\n    })\n\n    fallbackLocale = locales.fallbackLocale!\n    locale = locales.locale!\n  }\n\n  const customRequest: CustomPayloadRequestProperties = {\n    context: {},\n    fallbackLocale: fallbackLocale!,\n    hash: urlProperties.hash,\n    host: urlProperties.host,\n    href: urlProperties.href,\n    i18n,\n    locale,\n    origin: urlProperties.origin,\n    pathname: urlProperties.pathname,\n    payload,\n    payloadAPI: isGraphQL ? 'GraphQL' : 'REST',\n    payloadDataLoader: undefined!,\n    payloadUploadSizes: {},\n    port: urlProperties.port,\n    protocol: urlProperties.protocol,\n    query,\n    routeParams: params || {},\n    search: urlProperties.search,\n    searchParams: urlProperties.searchParams,\n    t: i18n.t,\n    transactionID: undefined,\n    user: null,\n  }\n\n  const req: PayloadRequest = Object.assign(request, customRequest)\n\n  req.payloadDataLoader = getDataLoader(req)\n\n  const { responseHeaders, user } = await executeAuthStrategies({\n    canSetHeaders,\n    headers: req.headers,\n    isGraphQL,\n    payload,\n  })\n\n  req.user = user\n\n  if (responseHeaders) {\n    req.responseHeaders = responseHeaders\n  }\n\n  return req\n}\n"],"names":["initI18n","qs","executeAuthStrategies","getDataLoader","getPayload","sanitizeLocales","getRequestLanguage","parseCookies","createPayloadRequest","canSetHeaders","config","configPromise","params","request","cookies","headers","payload","cron","localization","urlProperties","URL","url","pathname","searchParams","isGraphQL","graphQL","disable","routes","api","language","i18n","context","locale","get","search","queryToParse","query","parse","arrayLimit","depth","ignoreQueryPrefix","fallbackFromRequest","fallbackLocale","locales","customRequest","hash","host","href","origin","payloadAPI","payloadDataLoader","undefined","payloadUploadSizes","port","protocol","routeParams","t","transactionID","user","req","Object","assign","responseHeaders"],"mappings":"AAAA,SAASA,QAAQ,QAAQ,2BAA0B;AACnD,YAAYC,QAAQ,SAAQ;AAK5B,SAASC,qBAAqB,QAAQ,mCAAkC;AACxE,SAASC,aAAa,QAAQ,+BAA8B;AAC5D,SAASC,UAAU,QAAQ,cAAa;AACxC,SAASC,eAAe,QAAQ,2BAA0B;AAC1D,SAASC,kBAAkB,QAAQ,0BAAyB;AAC5D,SAASC,YAAY,QAAQ,oBAAmB;AAWhD,OAAO,MAAMC,uBAAuB,OAAO,EACzCC,aAAa,EACbC,QAAQC,aAAa,EACrBC,MAAM,EACNC,OAAO,EACF;IACL,MAAMC,UAAUP,aAAaM,QAAQE,OAAO;IAC5C,MAAMC,UAAU,MAAMZ,WAAW;QAAEM,QAAQC;QAAeM,MAAM;IAAK;IAErE,MAAM,EAAEP,MAAM,EAAE,GAAGM;IACnB,MAAME,eAAeR,OAAOQ,YAAY;IAExC,MAAMC,gBAAgB,IAAIC,IAAIP,QAAQQ,GAAG;IACzC,MAAM,EAAEC,QAAQ,EAAEC,YAAY,EAAE,GAAGJ;IAEnC,MAAMK,YACJ,CAACd,OAAOe,OAAO,CAACC,OAAO,IAAIJ,aAAa,GAAGZ,OAAOiB,MAAM,CAACC,GAAG,GAAGlB,OAAOiB,MAAM,CAACF,OAAO,EAAE;IAExF,MAAMI,WAAWvB,mBAAmB;QAClCI;QACAI;QACAC,SAASF,QAAQE,OAAO;IAC1B;IAEA,MAAMe,OAAO,MAAM9B,SAAS;QAC1BU,QAAQA,OAAOoB,IAAI;QACnBC,SAAS;QACTF;IACF;IAEA,IAAIG,SAAST,aAAaU,GAAG,CAAC;IAE9B,MAAM,EAAEC,QAAQC,YAAY,EAAE,GAAGhB;IAEjC,MAAMiB,QAAQD,eACVlC,GAAGoC,KAAK,CAACF,cAAc;QACrBG,YAAY;QACZC,OAAO;QACPC,mBAAmB;IACrB,KACA,CAAC;IAEL,MAAMC,sBACJ,AAACL,MAAMM,cAAc,IACrBnB,aAAaU,GAAG,CAAC,sBACjBV,aAAaU,GAAG,CAAC;IAEnB,IAAIS,iBAAiBD;IAErB,IAAIvB,cAAc;QAChB,MAAMyB,UAAUtC,gBAAgB;YAC9BqC,gBAAgBA;YAChBV,QAAQA;YACRd;QACF;QAEAwB,iBAAiBC,QAAQD,cAAc;QACvCV,SAASW,QAAQX,MAAM;IACzB;IAEA,MAAMY,gBAAgD;QACpDb,SAAS,CAAC;QACVW,gBAAgBA;QAChBG,MAAM1B,cAAc0B,IAAI;QACxBC,MAAM3B,cAAc2B,IAAI;QACxBC,MAAM5B,cAAc4B,IAAI;QACxBjB;QACAE;QACAgB,QAAQ7B,cAAc6B,MAAM;QAC5B1B,UAAUH,cAAcG,QAAQ;QAChCN;QACAiC,YAAYzB,YAAY,YAAY;QACpC0B,mBAAmBC;QACnBC,oBAAoB,CAAC;QACrBC,MAAMlC,cAAckC,IAAI;QACxBC,UAAUnC,cAAcmC,QAAQ;QAChClB;QACAmB,aAAa3C,UAAU,CAAC;QACxBsB,QAAQf,cAAce,MAAM;QAC5BX,cAAcJ,cAAcI,YAAY;QACxCiC,GAAG1B,KAAK0B,CAAC;QACTC,eAAeN;QACfO,MAAM;IACR;IAEA,MAAMC,MAAsBC,OAAOC,MAAM,CAAChD,SAAS+B;IAEnDe,IAAIT,iBAAiB,GAAG/C,cAAcwD;IAEtC,MAAM,EAAEG,eAAe,EAAEJ,IAAI,EAAE,GAAG,MAAMxD,sBAAsB;QAC5DO;QACAM,SAAS4C,IAAI5C,OAAO;QACpBS;QACAR;IACF;IAEA2C,IAAID,IAAI,GAAGA;IAEX,IAAII,iBAAiB;QACnBH,IAAIG,eAAe,GAAGA;IACxB;IAEA,OAAOH;AACT,EAAC"}