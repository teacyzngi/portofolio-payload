{"version":3,"sources":["../../../src/collections/operations/deleteByID.ts"],"sourcesContent":["import type { CollectionSlug } from '../../index.js'\nimport type {\n  PayloadRequest,\n  PopulateType,\n  SelectType,\n  TransformCollectionWithSelect,\n} from '../../types/index.js'\nimport type { Collection, DataFromCollectionSlug } from '../config/types.js'\n\nimport { executeAccess } from '../../auth/executeAccess.js'\nimport { hasWhereAccessResult } from '../../auth/types.js'\nimport { combineQueries } from '../../database/combineQueries.js'\nimport { Forbidden, NotFound } from '../../errors/index.js'\nimport { afterRead } from '../../fields/hooks/afterRead/index.js'\nimport { deleteUserPreferences } from '../../preferences/deleteUserPreferences.js'\nimport { deleteAssociatedFiles } from '../../uploads/deleteAssociatedFiles.js'\nimport { appendNonTrashedFilter } from '../../utilities/appendNonTrashedFilter.js'\nimport { checkDocumentLockStatus } from '../../utilities/checkDocumentLockStatus.js'\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { sanitizeSelect } from '../../utilities/sanitizeSelect.js'\nimport { deleteCollectionVersions } from '../../versions/deleteCollectionVersions.js'\nimport { deleteScheduledPublishJobs } from '../../versions/deleteScheduledPublishJobs.js'\nimport { buildAfterOperation } from './utils.js'\n\nexport type Arguments = {\n  collection: Collection\n  depth?: number\n  disableTransaction?: boolean\n  id: number | string\n  overrideAccess?: boolean\n  overrideLock?: boolean\n  populate?: PopulateType\n  req: PayloadRequest\n  select?: SelectType\n  showHiddenFields?: boolean\n  trash?: boolean\n}\n\nexport const deleteByIDOperation = async <TSlug extends CollectionSlug, TSelect extends SelectType>(\n  incomingArgs: Arguments,\n): Promise<TransformCollectionWithSelect<TSlug, TSelect>> => {\n  let args = incomingArgs\n\n  try {\n    const shouldCommit = !args.disableTransaction && (await initTransaction(args.req))\n\n    // /////////////////////////////////////\n    // beforeOperation - Collection\n    // /////////////////////////////////////\n\n    if (args.collection.config.hooks?.beforeOperation?.length) {\n      for (const hook of args.collection.config.hooks.beforeOperation) {\n        args =\n          (await hook({\n            args,\n            collection: args.collection.config,\n            context: args.req.context,\n            operation: 'delete',\n            req: args.req,\n          })) || args\n      }\n    }\n\n    const {\n      id,\n      collection: { config: collectionConfig },\n      depth,\n      overrideAccess,\n      overrideLock,\n      populate,\n      req: {\n        fallbackLocale,\n        locale,\n        payload: { config },\n        payload,\n      },\n      req,\n      select: incomingSelect,\n      showHiddenFields,\n      trash = false,\n    } = args\n\n    // /////////////////////////////////////\n    // Access\n    // /////////////////////////////////////\n\n    const accessResults = !overrideAccess\n      ? await executeAccess({ id, req }, collectionConfig.access.delete)\n      : true\n    const hasWhereAccess = hasWhereAccessResult(accessResults)\n\n    // /////////////////////////////////////\n    // beforeDelete - Collection\n    // /////////////////////////////////////\n\n    if (collectionConfig.hooks?.beforeDelete?.length) {\n      for (const hook of collectionConfig.hooks.beforeDelete) {\n        await hook({\n          id,\n          collection: collectionConfig,\n          context: req.context,\n          req,\n        })\n      }\n    }\n\n    // /////////////////////////////////////\n    // Retrieve document\n    // /////////////////////////////////////\n\n    let where = combineQueries({ id: { equals: id } }, accessResults)\n\n    // Exclude trashed documents when trash: false\n    where = appendNonTrashedFilter({\n      enableTrash: collectionConfig.trash,\n      trash,\n      where,\n    })\n\n    const docToDelete = await req.payload.db.findOne({\n      collection: collectionConfig.slug,\n      locale: req.locale!,\n      req,\n      where,\n    })\n\n    if (!docToDelete && !hasWhereAccess) {\n      throw new NotFound(req.t)\n    }\n    if (!docToDelete && hasWhereAccess) {\n      throw new Forbidden(req.t)\n    }\n\n    // /////////////////////////////////////\n    // Handle potentially locked documents\n    // /////////////////////////////////////\n\n    await checkDocumentLockStatus({\n      id,\n      collectionSlug: collectionConfig.slug,\n      lockErrorMessage: `Document with ID ${id} is currently locked and cannot be deleted.`,\n      overrideLock,\n      req,\n    })\n\n    await deleteAssociatedFiles({\n      collectionConfig,\n      config,\n      doc: docToDelete!,\n      overrideDelete: true,\n      req,\n    })\n\n    // /////////////////////////////////////\n    // Delete versions\n    // /////////////////////////////////////\n\n    if (collectionConfig.versions) {\n      await deleteCollectionVersions({\n        id,\n        slug: collectionConfig.slug,\n        payload,\n        req,\n      })\n    }\n\n    // /////////////////////////////////////\n    // Delete scheduled posts\n    // /////////////////////////////////////\n    if (collectionConfig.versions?.drafts && collectionConfig.versions.drafts.schedulePublish) {\n      await deleteScheduledPublishJobs({\n        id,\n        slug: collectionConfig.slug,\n        payload,\n        req,\n      })\n    }\n\n    const select = sanitizeSelect({\n      fields: collectionConfig.flattenedFields,\n      forceSelect: collectionConfig.forceSelect,\n      select: incomingSelect,\n    })\n\n    // /////////////////////////////////////\n    // Delete document\n    // /////////////////////////////////////\n\n    let result: DataFromCollectionSlug<TSlug> = await req.payload.db.deleteOne({\n      collection: collectionConfig.slug,\n      req,\n      select,\n      where: { id: { equals: id } },\n    })\n\n    // /////////////////////////////////////\n    // Delete Preferences\n    // /////////////////////////////////////\n\n    await deleteUserPreferences({\n      collectionConfig,\n      ids: [id],\n      payload,\n      req,\n    })\n\n    // /////////////////////////////////////\n    // afterRead - Fields\n    // /////////////////////////////////////\n\n    result = await afterRead({\n      collection: collectionConfig,\n      context: req.context,\n      depth: depth!,\n      doc: result,\n      draft: undefined!,\n      fallbackLocale: fallbackLocale!,\n      global: null,\n      locale: locale!,\n      overrideAccess: overrideAccess!,\n      populate,\n      req,\n      select,\n      showHiddenFields: showHiddenFields!,\n    })\n\n    // /////////////////////////////////////\n    // afterRead - Collection\n    // /////////////////////////////////////\n\n    if (collectionConfig.hooks?.afterRead?.length) {\n      for (const hook of collectionConfig.hooks.afterRead) {\n        result =\n          (await hook({\n            collection: collectionConfig,\n            context: req.context,\n            doc: result,\n            req,\n          })) || result\n      }\n    }\n\n    // /////////////////////////////////////\n    // afterDelete - Collection\n    // /////////////////////////////////////\n\n    if (collectionConfig.hooks?.afterDelete?.length) {\n      for (const hook of collectionConfig.hooks.afterDelete) {\n        result =\n          (await hook({\n            id,\n            collection: collectionConfig,\n            context: req.context,\n            doc: result,\n            req,\n          })) || result\n      }\n    }\n\n    // /////////////////////////////////////\n    // afterOperation - Collection\n    // /////////////////////////////////////\n\n    result = await buildAfterOperation({\n      args,\n      collection: collectionConfig,\n      operation: 'deleteByID',\n      result,\n    })\n\n    // /////////////////////////////////////\n    // 8. Return results\n    // /////////////////////////////////////\n\n    if (shouldCommit) {\n      await commitTransaction(req)\n    }\n\n    return result as TransformCollectionWithSelect<TSlug, TSelect>\n  } catch (error: unknown) {\n    await killTransaction(args.req)\n    throw error\n  }\n}\n"],"names":["executeAccess","hasWhereAccessResult","combineQueries","Forbidden","NotFound","afterRead","deleteUserPreferences","deleteAssociatedFiles","appendNonTrashedFilter","checkDocumentLockStatus","commitTransaction","initTransaction","killTransaction","sanitizeSelect","deleteCollectionVersions","deleteScheduledPublishJobs","buildAfterOperation","deleteByIDOperation","incomingArgs","args","shouldCommit","disableTransaction","req","collection","config","hooks","beforeOperation","length","hook","context","operation","id","collectionConfig","depth","overrideAccess","overrideLock","populate","fallbackLocale","locale","payload","select","incomingSelect","showHiddenFields","trash","accessResults","access","delete","hasWhereAccess","beforeDelete","where","equals","enableTrash","docToDelete","db","findOne","slug","t","collectionSlug","lockErrorMessage","doc","overrideDelete","versions","drafts","schedulePublish","fields","flattenedFields","forceSelect","result","deleteOne","ids","draft","undefined","global","afterDelete","error"],"mappings":"AASA,SAASA,aAAa,QAAQ,8BAA6B;AAC3D,SAASC,oBAAoB,QAAQ,sBAAqB;AAC1D,SAASC,cAAc,QAAQ,mCAAkC;AACjE,SAASC,SAAS,EAAEC,QAAQ,QAAQ,wBAAuB;AAC3D,SAASC,SAAS,QAAQ,wCAAuC;AACjE,SAASC,qBAAqB,QAAQ,6CAA4C;AAClF,SAASC,qBAAqB,QAAQ,yCAAwC;AAC9E,SAASC,sBAAsB,QAAQ,4CAA2C;AAClF,SAASC,uBAAuB,QAAQ,6CAA4C;AACpF,SAASC,iBAAiB,QAAQ,uCAAsC;AACxE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,cAAc,QAAQ,oCAAmC;AAClE,SAASC,wBAAwB,QAAQ,6CAA4C;AACrF,SAASC,0BAA0B,QAAQ,+CAA8C;AACzF,SAASC,mBAAmB,QAAQ,aAAY;AAgBhD,OAAO,MAAMC,sBAAsB,OACjCC;IAEA,IAAIC,OAAOD;IAEX,IAAI;QACF,MAAME,eAAe,CAACD,KAAKE,kBAAkB,IAAK,MAAMV,gBAAgBQ,KAAKG,GAAG;QAEhF,wCAAwC;QACxC,+BAA+B;QAC/B,wCAAwC;QAExC,IAAIH,KAAKI,UAAU,CAACC,MAAM,CAACC,KAAK,EAAEC,iBAAiBC,QAAQ;YACzD,KAAK,MAAMC,QAAQT,KAAKI,UAAU,CAACC,MAAM,CAACC,KAAK,CAACC,eAAe,CAAE;gBAC/DP,OACE,AAAC,MAAMS,KAAK;oBACVT;oBACAI,YAAYJ,KAAKI,UAAU,CAACC,MAAM;oBAClCK,SAASV,KAAKG,GAAG,CAACO,OAAO;oBACzBC,WAAW;oBACXR,KAAKH,KAAKG,GAAG;gBACf,MAAOH;YACX;QACF;QAEA,MAAM,EACJY,EAAE,EACFR,YAAY,EAAEC,QAAQQ,gBAAgB,EAAE,EACxCC,KAAK,EACLC,cAAc,EACdC,YAAY,EACZC,QAAQ,EACRd,KAAK,EACHe,cAAc,EACdC,MAAM,EACNC,SAAS,EAAEf,MAAM,EAAE,EACnBe,OAAO,EACR,EACDjB,GAAG,EACHkB,QAAQC,cAAc,EACtBC,gBAAgB,EAChBC,QAAQ,KAAK,EACd,GAAGxB;QAEJ,wCAAwC;QACxC,SAAS;QACT,wCAAwC;QAExC,MAAMyB,gBAAgB,CAACV,iBACnB,MAAMlC,cAAc;YAAE+B;YAAIT;QAAI,GAAGU,iBAAiBa,MAAM,CAACC,MAAM,IAC/D;QACJ,MAAMC,iBAAiB9C,qBAAqB2C;QAE5C,wCAAwC;QACxC,4BAA4B;QAC5B,wCAAwC;QAExC,IAAIZ,iBAAiBP,KAAK,EAAEuB,cAAcrB,QAAQ;YAChD,KAAK,MAAMC,QAAQI,iBAAiBP,KAAK,CAACuB,YAAY,CAAE;gBACtD,MAAMpB,KAAK;oBACTG;oBACAR,YAAYS;oBACZH,SAASP,IAAIO,OAAO;oBACpBP;gBACF;YACF;QACF;QAEA,wCAAwC;QACxC,oBAAoB;QACpB,wCAAwC;QAExC,IAAI2B,QAAQ/C,eAAe;YAAE6B,IAAI;gBAAEmB,QAAQnB;YAAG;QAAE,GAAGa;QAEnD,8CAA8C;QAC9CK,QAAQzC,uBAAuB;YAC7B2C,aAAanB,iBAAiBW,KAAK;YACnCA;YACAM;QACF;QAEA,MAAMG,cAAc,MAAM9B,IAAIiB,OAAO,CAACc,EAAE,CAACC,OAAO,CAAC;YAC/C/B,YAAYS,iBAAiBuB,IAAI;YACjCjB,QAAQhB,IAAIgB,MAAM;YAClBhB;YACA2B;QACF;QAEA,IAAI,CAACG,eAAe,CAACL,gBAAgB;YACnC,MAAM,IAAI3C,SAASkB,IAAIkC,CAAC;QAC1B;QACA,IAAI,CAACJ,eAAeL,gBAAgB;YAClC,MAAM,IAAI5C,UAAUmB,IAAIkC,CAAC;QAC3B;QAEA,wCAAwC;QACxC,sCAAsC;QACtC,wCAAwC;QAExC,MAAM/C,wBAAwB;YAC5BsB;YACA0B,gBAAgBzB,iBAAiBuB,IAAI;YACrCG,kBAAkB,CAAC,iBAAiB,EAAE3B,GAAG,2CAA2C,CAAC;YACrFI;YACAb;QACF;QAEA,MAAMf,sBAAsB;YAC1ByB;YACAR;YACAmC,KAAKP;YACLQ,gBAAgB;YAChBtC;QACF;QAEA,wCAAwC;QACxC,kBAAkB;QAClB,wCAAwC;QAExC,IAAIU,iBAAiB6B,QAAQ,EAAE;YAC7B,MAAM/C,yBAAyB;gBAC7BiB;gBACAwB,MAAMvB,iBAAiBuB,IAAI;gBAC3BhB;gBACAjB;YACF;QACF;QAEA,wCAAwC;QACxC,yBAAyB;QACzB,wCAAwC;QACxC,IAAIU,iBAAiB6B,QAAQ,EAAEC,UAAU9B,iBAAiB6B,QAAQ,CAACC,MAAM,CAACC,eAAe,EAAE;YACzF,MAAMhD,2BAA2B;gBAC/BgB;gBACAwB,MAAMvB,iBAAiBuB,IAAI;gBAC3BhB;gBACAjB;YACF;QACF;QAEA,MAAMkB,SAAS3B,eAAe;YAC5BmD,QAAQhC,iBAAiBiC,eAAe;YACxCC,aAAalC,iBAAiBkC,WAAW;YACzC1B,QAAQC;QACV;QAEA,wCAAwC;QACxC,kBAAkB;QAClB,wCAAwC;QAExC,IAAI0B,SAAwC,MAAM7C,IAAIiB,OAAO,CAACc,EAAE,CAACe,SAAS,CAAC;YACzE7C,YAAYS,iBAAiBuB,IAAI;YACjCjC;YACAkB;YACAS,OAAO;gBAAElB,IAAI;oBAAEmB,QAAQnB;gBAAG;YAAE;QAC9B;QAEA,wCAAwC;QACxC,qBAAqB;QACrB,wCAAwC;QAExC,MAAMzB,sBAAsB;YAC1B0B;YACAqC,KAAK;gBAACtC;aAAG;YACTQ;YACAjB;QACF;QAEA,wCAAwC;QACxC,qBAAqB;QACrB,wCAAwC;QAExC6C,SAAS,MAAM9D,UAAU;YACvBkB,YAAYS;YACZH,SAASP,IAAIO,OAAO;YACpBI,OAAOA;YACP0B,KAAKQ;YACLG,OAAOC;YACPlC,gBAAgBA;YAChBmC,QAAQ;YACRlC,QAAQA;YACRJ,gBAAgBA;YAChBE;YACAd;YACAkB;YACAE,kBAAkBA;QACpB;QAEA,wCAAwC;QACxC,yBAAyB;QACzB,wCAAwC;QAExC,IAAIV,iBAAiBP,KAAK,EAAEpB,WAAWsB,QAAQ;YAC7C,KAAK,MAAMC,QAAQI,iBAAiBP,KAAK,CAACpB,SAAS,CAAE;gBACnD8D,SACE,AAAC,MAAMvC,KAAK;oBACVL,YAAYS;oBACZH,SAASP,IAAIO,OAAO;oBACpB8B,KAAKQ;oBACL7C;gBACF,MAAO6C;YACX;QACF;QAEA,wCAAwC;QACxC,2BAA2B;QAC3B,wCAAwC;QAExC,IAAInC,iBAAiBP,KAAK,EAAEgD,aAAa9C,QAAQ;YAC/C,KAAK,MAAMC,QAAQI,iBAAiBP,KAAK,CAACgD,WAAW,CAAE;gBACrDN,SACE,AAAC,MAAMvC,KAAK;oBACVG;oBACAR,YAAYS;oBACZH,SAASP,IAAIO,OAAO;oBACpB8B,KAAKQ;oBACL7C;gBACF,MAAO6C;YACX;QACF;QAEA,wCAAwC;QACxC,8BAA8B;QAC9B,wCAAwC;QAExCA,SAAS,MAAMnD,oBAAoB;YACjCG;YACAI,YAAYS;YACZF,WAAW;YACXqC;QACF;QAEA,wCAAwC;QACxC,oBAAoB;QACpB,wCAAwC;QAExC,IAAI/C,cAAc;YAChB,MAAMV,kBAAkBY;QAC1B;QAEA,OAAO6C;IACT,EAAE,OAAOO,OAAgB;QACvB,MAAM9D,gBAAgBO,KAAKG,GAAG;QAC9B,MAAMoD;IACR;AACF,EAAC"}