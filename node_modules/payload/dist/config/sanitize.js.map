{"version":3,"sources":["../../src/config/sanitize.ts"],"sourcesContent":["import type { AcceptedLanguages } from '@payloadcms/translations'\n\nimport { en } from '@payloadcms/translations/languages/en'\nimport { deepMergeSimple } from '@payloadcms/translations/utilities'\n\nimport type { CollectionSlug, GlobalSlug, SanitizedCollectionConfig } from '../index.js'\nimport type { SanitizedJobsConfig } from '../queues/config/types/index.js'\nimport type {\n  Config,\n  LocalizationConfigWithLabels,\n  LocalizationConfigWithNoLabels,\n  SanitizedConfig,\n  Timezone,\n} from './types.js'\n\nimport { defaultUserCollection } from '../auth/defaultUser.js'\nimport { authRootEndpoints } from '../auth/endpoints/index.js'\nimport { sanitizeCollection } from '../collections/config/sanitize.js'\nimport { migrationsCollection } from '../database/migrations/migrationsCollection.js'\nimport { DuplicateCollection, InvalidConfiguration } from '../errors/index.js'\nimport { defaultTimezones } from '../fields/baseFields/timezone/defaultTimezones.js'\nimport { addFolderCollection } from '../folders/addFolderCollection.js'\nimport { addFolderFieldToCollection } from '../folders/addFolderFieldToCollection.js'\nimport { sanitizeGlobal } from '../globals/config/sanitize.js'\nimport { baseBlockFields, formatLabels, sanitizeFields } from '../index.js'\nimport {\n  getLockedDocumentsCollection,\n  lockedDocumentsCollectionSlug,\n} from '../locked-documents/config.js'\nimport { getPreferencesCollection, preferencesCollectionSlug } from '../preferences/config.js'\nimport { getQueryPresetsConfig, queryPresetsCollectionSlug } from '../query-presets/config.js'\nimport { getDefaultJobsCollection, jobsCollectionSlug } from '../queues/config/collection.js'\nimport { getJobStatsGlobal } from '../queues/config/global.js'\nimport { flattenBlock } from '../utilities/flattenAllFields.js'\nimport { getSchedulePublishTask } from '../versions/schedule/job.js'\nimport { addDefaultsToConfig } from './defaults.js'\nimport { setupOrderable } from './orderable/index.js'\n\nconst sanitizeAdminConfig = (configToSanitize: Config): Partial<SanitizedConfig> => {\n  const sanitizedConfig = { ...configToSanitize }\n\n  if (configToSanitize?.compatibility?.allowLocalizedWithinLocalized) {\n    process.env.NEXT_PUBLIC_PAYLOAD_COMPATIBILITY_allowLocalizedWithinLocalized = 'true'\n  }\n\n  // default logging level will be 'error' if not provided\n  sanitizedConfig.loggingLevels = {\n    Forbidden: 'info',\n    Locked: 'info',\n    MissingFile: 'info',\n    NotFound: 'info',\n    ValidationError: 'info',\n    ...(sanitizedConfig.loggingLevels || {}),\n  }\n\n  // add default user collection if none provided\n  if (!sanitizedConfig?.admin?.user) {\n    const firstCollectionWithAuth = sanitizedConfig.collections!.find(({ auth }) => Boolean(auth))\n\n    if (firstCollectionWithAuth) {\n      sanitizedConfig.admin!.user = firstCollectionWithAuth.slug\n    } else {\n      sanitizedConfig.admin!.user = defaultUserCollection.slug\n      sanitizedConfig.collections!.push(defaultUserCollection)\n    }\n  }\n\n  const userCollection = sanitizedConfig.collections!.find(\n    ({ slug }) => slug === sanitizedConfig.admin!.user,\n  )\n\n  if (!userCollection || !userCollection.auth) {\n    throw new InvalidConfiguration(\n      `${sanitizedConfig.admin!.user} is not a valid admin user collection`,\n    )\n  }\n\n  if (sanitizedConfig?.admin?.timezones) {\n    if (typeof sanitizedConfig?.admin?.timezones?.supportedTimezones === 'function') {\n      sanitizedConfig.admin.timezones.supportedTimezones =\n        sanitizedConfig.admin.timezones.supportedTimezones({ defaultTimezones })\n    }\n\n    if (!sanitizedConfig?.admin?.timezones?.supportedTimezones) {\n      sanitizedConfig.admin.timezones.supportedTimezones = defaultTimezones\n    }\n  } else {\n    sanitizedConfig.admin!.timezones = {\n      supportedTimezones: defaultTimezones,\n    }\n  }\n  // Timezones supported by the Intl API\n  const _internalSupportedTimezones = Intl.supportedValuesOf('timeZone')\n\n  // We're casting here because it's already been sanitised above but TS still thinks it could be a function\n  ;(sanitizedConfig.admin!.timezones.supportedTimezones as Timezone[]).forEach((timezone) => {\n    if (!_internalSupportedTimezones.includes(timezone.value)) {\n      throw new InvalidConfiguration(\n        `Timezone ${timezone.value} is not supported by the current runtime via the Intl API.`,\n      )\n    }\n  })\n\n  return sanitizedConfig as unknown as Partial<SanitizedConfig>\n}\n\nexport const sanitizeConfig = async (incomingConfig: Config): Promise<SanitizedConfig> => {\n  const configWithDefaults = addDefaultsToConfig(incomingConfig)\n\n  const config: Partial<SanitizedConfig> = sanitizeAdminConfig(configWithDefaults)\n\n  // Add orderable fields\n  setupOrderable(config as SanitizedConfig)\n\n  if (!config.endpoints) {\n    config.endpoints = []\n  }\n\n  for (const endpoint of authRootEndpoints) {\n    config.endpoints.push(endpoint)\n  }\n\n  if (config.localization && config.localization.locales?.length > 0) {\n    // clone localization config so to not break everything\n    const firstLocale = config.localization.locales[0]\n    if (typeof firstLocale === 'string') {\n      config.localization.localeCodes = [\n        ...(config.localization as unknown as LocalizationConfigWithNoLabels).locales,\n      ]\n\n      // is string[], so convert to Locale[]\n      config.localization.locales = (\n        config.localization as unknown as LocalizationConfigWithNoLabels\n      ).locales.map((locale) => ({\n        code: locale,\n        label: locale,\n        rtl: false,\n        toString: () => locale,\n      }))\n    } else {\n      // is Locale[], so convert to string[] for localeCodes\n      config.localization.localeCodes = config.localization.locales.map((locale) => locale.code)\n\n      config.localization.locales = (\n        config.localization as LocalizationConfigWithLabels\n      ).locales.map((locale) => ({\n        ...locale,\n        toString: () => locale.code,\n      }))\n    }\n\n    // Default fallback to true if not provided\n    config.localization.fallback = config.localization?.fallback ?? true\n  }\n\n  const i18nConfig: SanitizedConfig['i18n'] = {\n    fallbackLanguage: 'en',\n    supportedLanguages: {\n      en,\n    },\n    translations: {},\n  }\n\n  if (incomingConfig?.i18n) {\n    i18nConfig.supportedLanguages =\n      incomingConfig.i18n?.supportedLanguages || i18nConfig.supportedLanguages\n\n    const supportedLangKeys = <AcceptedLanguages[]>Object.keys(i18nConfig.supportedLanguages)\n    const fallbackLang = incomingConfig.i18n?.fallbackLanguage || i18nConfig.fallbackLanguage\n\n    i18nConfig.fallbackLanguage = supportedLangKeys.includes(fallbackLang)\n      ? fallbackLang\n      : supportedLangKeys[0]!\n    i18nConfig.translations =\n      (incomingConfig.i18n?.translations as SanitizedConfig['i18n']['translations']) ||\n      i18nConfig.translations\n  }\n\n  config.i18n = i18nConfig\n\n  const richTextSanitizationPromises: Array<(config: SanitizedConfig) => Promise<void>> = []\n\n  const schedulePublishCollections: CollectionSlug[] = []\n\n  const queryPresetsCollections: CollectionSlug[] = []\n\n  const schedulePublishGlobals: GlobalSlug[] = []\n\n  const collectionSlugs = new Set<CollectionSlug>()\n\n  const validRelationships = [\n    ...(config.collections?.map((c) => c.slug) ?? []),\n    jobsCollectionSlug,\n    lockedDocumentsCollectionSlug,\n    preferencesCollectionSlug,\n  ]\n\n  if (config.folders !== false) {\n    validRelationships.push(config.folders!.slug)\n  }\n\n  /**\n   * Blocks sanitization needs to happen before collections, as collection/global join field sanitization needs config.blocks\n   * to be populated with the sanitized blocks\n   */\n  config.blocks = []\n\n  if (incomingConfig.blocks?.length) {\n    for (const block of incomingConfig.blocks) {\n      const sanitizedBlock = block\n\n      if (sanitizedBlock._sanitized === true) {\n        continue\n      }\n      sanitizedBlock._sanitized = true\n\n      sanitizedBlock.fields = sanitizedBlock.fields.concat(baseBlockFields)\n\n      sanitizedBlock.labels = !sanitizedBlock.labels\n        ? formatLabels(sanitizedBlock.slug)\n        : sanitizedBlock.labels\n\n      sanitizedBlock.fields = await sanitizeFields({\n        config: config as unknown as Config,\n        existingFieldNames: new Set(),\n        fields: sanitizedBlock.fields,\n        parentIsLocalized: false,\n        richTextSanitizationPromises,\n        validRelationships,\n      })\n\n      const flattenedSanitizedBlock = flattenBlock({ block })\n\n      config.blocks.push(flattenedSanitizedBlock)\n    }\n  }\n\n  const folderEnabledCollections: SanitizedCollectionConfig[] = []\n\n  for (let i = 0; i < config.collections!.length; i++) {\n    if (collectionSlugs.has(config.collections![i]!.slug)) {\n      throw new DuplicateCollection('slug', config.collections![i]!.slug)\n    }\n\n    collectionSlugs.add(config.collections![i]!.slug)\n\n    const draftsConfig = config.collections![i]?.versions?.drafts\n\n    if (typeof draftsConfig === 'object' && draftsConfig.schedulePublish) {\n      schedulePublishCollections.push(config.collections![i]!.slug)\n    }\n\n    if (config.collections![i]!.enableQueryPresets) {\n      queryPresetsCollections.push(config.collections![i]!.slug)\n\n      if (!validRelationships.includes(queryPresetsCollectionSlug)) {\n        validRelationships.push(queryPresetsCollectionSlug)\n      }\n    }\n\n    if (config.folders !== false && config.collections![i]!.folders) {\n      addFolderFieldToCollection({\n        collection: config.collections![i]!,\n        collectionSpecific: config.folders!.collectionSpecific,\n        folderFieldName: config.folders!.fieldName,\n        folderSlug: config.folders!.slug,\n      })\n    }\n\n    config.collections![i] = await sanitizeCollection(\n      config as unknown as Config,\n      config.collections![i]!,\n      richTextSanitizationPromises,\n      validRelationships,\n    )\n\n    if (config.folders !== false && config.collections![i]!.folders) {\n      folderEnabledCollections.push(config.collections![i]!)\n    }\n  }\n\n  if (config.globals!.length > 0) {\n    for (let i = 0; i < config.globals!.length; i++) {\n      const draftsConfig = config.globals![i]?.versions?.drafts\n\n      if (typeof draftsConfig === 'object' && draftsConfig.schedulePublish) {\n        schedulePublishGlobals.push(config.globals![i]!.slug)\n      }\n\n      config.globals![i] = await sanitizeGlobal(\n        config as unknown as Config,\n        config.globals![i]!,\n        richTextSanitizationPromises,\n        validRelationships,\n      )\n    }\n  }\n\n  if (schedulePublishCollections.length || schedulePublishGlobals.length) {\n    ;((config.jobs ??= {} as SanitizedJobsConfig).tasks ??= []).push(\n      getSchedulePublishTask({\n        adminUserSlug: config.admin!.user,\n        collections: schedulePublishCollections,\n        globals: schedulePublishGlobals,\n      }),\n    )\n  }\n\n  ;(config.jobs ??= {} as SanitizedJobsConfig).enabled = Boolean(\n    (Array.isArray(configWithDefaults.jobs?.tasks) && configWithDefaults.jobs?.tasks?.length) ||\n      (Array.isArray(configWithDefaults.jobs?.workflows) &&\n        configWithDefaults.jobs?.workflows?.length),\n  )\n\n  // Need to add default jobs collection before locked documents collections\n  if (config.jobs.enabled) {\n    // Check for schedule property in both tasks and workflows\n    const hasScheduleProperty =\n      (config?.jobs?.tasks?.length && config.jobs.tasks.some((task) => task.schedule)) ||\n      (config?.jobs?.workflows?.length &&\n        config.jobs.workflows.some((workflow) => workflow.schedule))\n\n    if (hasScheduleProperty) {\n      config.jobs.scheduling = true\n      // Add payload-jobs-stats global for tracking when a job of a specific slug was last run\n      ;(config.globals ??= []).push(\n        await sanitizeGlobal(\n          config as unknown as Config,\n          getJobStatsGlobal(config as unknown as Config),\n          richTextSanitizationPromises,\n          validRelationships,\n        ),\n      )\n\n      config.jobs.stats = true\n    }\n\n    let defaultJobsCollection = getDefaultJobsCollection(config.jobs)\n\n    if (typeof config.jobs.jobsCollectionOverrides === 'function') {\n      defaultJobsCollection = config.jobs.jobsCollectionOverrides({\n        defaultJobsCollection,\n      })\n\n      const hooks = defaultJobsCollection?.hooks\n      // @todo - delete this check in 4.0\n      if (hooks && config?.jobs?.runHooks !== true) {\n        for (const [hookKey, hook] of Object.entries(hooks)) {\n          const defaultAmount = hookKey === 'afterRead' || hookKey === 'beforeChange' ? 1 : 0\n          if (hook.length > defaultAmount) {\n            // eslint-disable-next-line no-console\n            console.warn(\n              `The jobsCollectionOverrides function is returning a collection with an additional ${hookKey} hook defined. These hooks will not run unless the jobs.runHooks option is set to true. Setting this option to true will negatively impact performance.`,\n            )\n            break\n          }\n        }\n      }\n    }\n    const sanitizedJobsCollection = await sanitizeCollection(\n      config as unknown as Config,\n      defaultJobsCollection,\n      richTextSanitizationPromises,\n      validRelationships,\n    )\n\n    ;(config.collections ??= []).push(sanitizedJobsCollection)\n  }\n\n  if (config.folders !== false && folderEnabledCollections.length) {\n    await addFolderCollection({\n      collectionSpecific: config.folders!.collectionSpecific,\n      config: config as unknown as Config,\n      folderEnabledCollections,\n      richTextSanitizationPromises,\n      validRelationships,\n    })\n  }\n\n  configWithDefaults.collections!.push(\n    await sanitizeCollection(\n      config as unknown as Config,\n      getLockedDocumentsCollection(config as unknown as Config),\n      richTextSanitizationPromises,\n      validRelationships,\n    ),\n  )\n\n  configWithDefaults.collections!.push(\n    await sanitizeCollection(\n      config as unknown as Config,\n      getPreferencesCollection(config as unknown as Config),\n      richTextSanitizationPromises,\n      validRelationships,\n    ),\n  )\n\n  configWithDefaults.collections!.push(\n    await sanitizeCollection(\n      config as unknown as Config,\n      migrationsCollection,\n      richTextSanitizationPromises,\n      validRelationships,\n    ),\n  )\n\n  if (queryPresetsCollections.length > 0) {\n    configWithDefaults.collections!.push(\n      await sanitizeCollection(\n        config as unknown as Config,\n        getQueryPresetsConfig(config as unknown as Config),\n        richTextSanitizationPromises,\n        validRelationships,\n      ),\n    )\n  }\n\n  if (config.serverURL !== '') {\n    config.csrf!.push(config.serverURL!)\n  }\n\n  const uploadAdapters = new Set<string>()\n  // interact with all collections\n  for (const collection of config.collections!) {\n    // deduped upload adapters\n    if (collection.upload?.adapter) {\n      uploadAdapters.add(collection.upload.adapter)\n    }\n  }\n\n  if (!config.upload) {\n    config.upload = { adapters: [] }\n  }\n\n  config.upload.adapters = Array.from(\n    new Set(config.collections!.map((c) => c.upload?.adapter).filter(Boolean) as string[]),\n  )\n\n  // Pass through the email config as is so adapters don't break\n  if (incomingConfig.email) {\n    config.email = incomingConfig.email\n  }\n\n  /*\n    Execute richText sanitization\n   */\n  if (typeof incomingConfig.editor === 'function') {\n    config.editor = await incomingConfig.editor({\n      config: config as SanitizedConfig,\n      isRoot: true,\n      parentIsLocalized: false,\n    })\n    if (config.editor.i18n && Object.keys(config.editor.i18n).length >= 0) {\n      config.i18n.translations = deepMergeSimple(config.i18n.translations, config.editor.i18n)\n    }\n  }\n\n  const promises: Promise<void>[] = []\n\n  for (const sanitizeFunction of richTextSanitizationPromises) {\n    promises.push(sanitizeFunction(config as SanitizedConfig))\n  }\n\n  await Promise.all(promises)\n\n  return config as SanitizedConfig\n}\n"],"names":["en","deepMergeSimple","defaultUserCollection","authRootEndpoints","sanitizeCollection","migrationsCollection","DuplicateCollection","InvalidConfiguration","defaultTimezones","addFolderCollection","addFolderFieldToCollection","sanitizeGlobal","baseBlockFields","formatLabels","sanitizeFields","getLockedDocumentsCollection","lockedDocumentsCollectionSlug","getPreferencesCollection","preferencesCollectionSlug","getQueryPresetsConfig","queryPresetsCollectionSlug","getDefaultJobsCollection","jobsCollectionSlug","getJobStatsGlobal","flattenBlock","getSchedulePublishTask","addDefaultsToConfig","setupOrderable","sanitizeAdminConfig","configToSanitize","sanitizedConfig","compatibility","allowLocalizedWithinLocalized","process","env","NEXT_PUBLIC_PAYLOAD_COMPATIBILITY_allowLocalizedWithinLocalized","loggingLevels","Forbidden","Locked","MissingFile","NotFound","ValidationError","admin","user","firstCollectionWithAuth","collections","find","auth","Boolean","slug","push","userCollection","timezones","supportedTimezones","_internalSupportedTimezones","Intl","supportedValuesOf","forEach","timezone","includes","value","sanitizeConfig","incomingConfig","configWithDefaults","config","endpoints","endpoint","localization","locales","length","firstLocale","localeCodes","map","locale","code","label","rtl","toString","fallback","i18nConfig","fallbackLanguage","supportedLanguages","translations","i18n","supportedLangKeys","Object","keys","fallbackLang","richTextSanitizationPromises","schedulePublishCollections","queryPresetsCollections","schedulePublishGlobals","collectionSlugs","Set","validRelationships","c","folders","blocks","block","sanitizedBlock","_sanitized","fields","concat","labels","existingFieldNames","parentIsLocalized","flattenedSanitizedBlock","folderEnabledCollections","i","has","add","draftsConfig","versions","drafts","schedulePublish","enableQueryPresets","collection","collectionSpecific","folderFieldName","fieldName","folderSlug","globals","jobs","tasks","adminUserSlug","enabled","Array","isArray","workflows","hasScheduleProperty","some","task","schedule","workflow","scheduling","stats","defaultJobsCollection","jobsCollectionOverrides","hooks","runHooks","hookKey","hook","entries","defaultAmount","console","warn","sanitizedJobsCollection","serverURL","csrf","uploadAdapters","upload","adapter","adapters","from","filter","email","editor","isRoot","promises","sanitizeFunction","Promise","all"],"mappings":"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"}