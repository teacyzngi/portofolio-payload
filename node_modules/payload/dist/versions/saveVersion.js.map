{"version":3,"sources":["../../src/versions/saveVersion.ts"],"sourcesContent":["// @ts-strict-ignore\nimport type { SanitizedCollectionConfig, TypeWithID } from '../collections/config/types.js'\nimport type { SanitizedGlobalConfig } from '../globals/config/types.js'\nimport type { CreateGlobalVersionArgs, CreateVersionArgs, Payload } from '../index.js'\nimport type { PayloadRequest, SelectType } from '../types/index.js'\n\nimport { deepCopyObjectSimple } from '../index.js'\nimport { sanitizeInternalFields } from '../utilities/sanitizeInternalFields.js'\nimport { getQueryDraftsSelect } from './drafts/getQueryDraftsSelect.js'\nimport { enforceMaxVersions } from './enforceMaxVersions.js'\n\ntype Args = {\n  autosave?: boolean\n  collection?: SanitizedCollectionConfig\n  docWithLocales: any\n  draft?: boolean\n  global?: SanitizedGlobalConfig\n  id?: number | string\n  operation?: 'create' | 'restoreVersion' | 'update'\n  payload: Payload\n  publishSpecificLocale?: string\n  req?: PayloadRequest\n  select?: SelectType\n  snapshot?: any\n}\n\nexport const saveVersion = async ({\n  id,\n  autosave,\n  collection,\n  docWithLocales: doc,\n  draft,\n  global,\n  operation,\n  payload,\n  publishSpecificLocale,\n  req,\n  select,\n  snapshot,\n}: Args): Promise<TypeWithID> => {\n  let result: TypeWithID | undefined\n  let createNewVersion = true\n  const now = new Date().toISOString()\n  const versionData = deepCopyObjectSimple(doc)\n  if (draft) {\n    versionData._status = 'draft'\n  }\n\n  if (collection?.timestamps && draft) {\n    versionData.updatedAt = now\n  }\n\n  if (versionData._id) {\n    delete versionData._id\n  }\n\n  try {\n    if (autosave) {\n      let docs\n      const findVersionArgs = {\n        limit: 1,\n        pagination: false,\n        req,\n        sort: '-updatedAt',\n      }\n\n      if (collection) {\n        ;({ docs } = await payload.db.findVersions({\n          ...findVersionArgs,\n          collection: collection.slug,\n          limit: 1,\n          pagination: false,\n          req,\n          where: {\n            parent: {\n              equals: id,\n            },\n          },\n        }))\n      } else {\n        ;({ docs } = await payload.db.findGlobalVersions({\n          ...findVersionArgs,\n          global: global!.slug,\n          limit: 1,\n          pagination: false,\n          req,\n        }))\n      }\n      const [latestVersion] = docs\n\n      // overwrite the latest version if it's set to autosave\n      if (latestVersion && 'autosave' in latestVersion && latestVersion.autosave === true) {\n        createNewVersion = false\n\n        const data: Record<string, unknown> = {\n          createdAt: new Date(latestVersion.createdAt).toISOString(),\n          latest: true,\n          parent: id,\n          updatedAt: now,\n          version: {\n            ...versionData,\n          },\n        }\n\n        const updateVersionArgs = {\n          id: latestVersion.id,\n          req,\n          versionData: data as TypeWithID,\n        }\n\n        if (collection) {\n          result = await payload.db.updateVersion({\n            ...updateVersionArgs,\n            collection: collection.slug,\n            req,\n          })\n        } else {\n          result = await payload.db.updateGlobalVersion({\n            ...updateVersionArgs,\n            global: global!.slug,\n            req,\n          })\n        }\n      }\n    }\n\n    if (createNewVersion) {\n      const createVersionArgs = {\n        autosave: Boolean(autosave),\n        collectionSlug: undefined as string | undefined,\n        createdAt: operation === 'restoreVersion' ? versionData.createdAt : now,\n        globalSlug: undefined as string | undefined,\n        parent: collection ? id : undefined,\n        publishedLocale: publishSpecificLocale || undefined,\n        req,\n        select: getQueryDraftsSelect({ select }),\n        updatedAt: now,\n        versionData,\n      }\n\n      if (collection) {\n        createVersionArgs.collectionSlug = collection.slug\n        result = await payload.db.createVersion(createVersionArgs as CreateVersionArgs)\n      }\n\n      if (global) {\n        createVersionArgs.globalSlug = global.slug\n        result = await payload.db.createGlobalVersion(createVersionArgs as CreateGlobalVersionArgs)\n      }\n\n      if (publishSpecificLocale && snapshot) {\n        const snapshotData = deepCopyObjectSimple(snapshot)\n        if (snapshotData._id) {\n          delete snapshotData._id\n        }\n\n        snapshotData._status = 'draft'\n\n        const snapshotDate = new Date().toISOString()\n\n        const updatedArgs = {\n          ...createVersionArgs,\n          createdAt: snapshotDate,\n          returning: false,\n          snapshot: true,\n          updatedAt: snapshotDate,\n          versionData: snapshotData,\n        } as CreateGlobalVersionArgs & CreateVersionArgs\n\n        if (collection) {\n          await payload.db.createVersion(updatedArgs)\n        }\n        if (global) {\n          await payload.db.createGlobalVersion(updatedArgs)\n        }\n      }\n    }\n  } catch (err) {\n    let errorMessage: string | undefined\n\n    if (collection) {\n      errorMessage = `There was an error while saving a version for the ${typeof collection.labels.singular === 'string' ? collection.labels.singular : collection.slug} with ID ${id}.`\n    }\n    if (global) {\n      errorMessage = `There was an error while saving a version for the global ${typeof global.label === 'string' ? global.label : global.slug}.`\n    }\n    payload.logger.error({ err, msg: errorMessage })\n    return undefined!\n  }\n\n  const max = collection ? collection.versions.maxPerDoc : global!.versions.max\n\n  if (createNewVersion && max > 0) {\n    await enforceMaxVersions({\n      id,\n      collection,\n      global,\n      max,\n      payload,\n      req,\n    })\n  }\n\n  let createdVersion = (result as any).version\n\n  createdVersion = sanitizeInternalFields(createdVersion)\n  createdVersion.id = (result as any).parent\n\n  return createdVersion\n}\n"],"names":["deepCopyObjectSimple","sanitizeInternalFields","getQueryDraftsSelect","enforceMaxVersions","saveVersion","id","autosave","collection","docWithLocales","doc","draft","global","operation","payload","publishSpecificLocale","req","select","snapshot","result","createNewVersion","now","Date","toISOString","versionData","_status","timestamps","updatedAt","_id","docs","findVersionArgs","limit","pagination","sort","db","findVersions","slug","where","parent","equals","findGlobalVersions","latestVersion","data","createdAt","latest","version","updateVersionArgs","updateVersion","updateGlobalVersion","createVersionArgs","Boolean","collectionSlug","undefined","globalSlug","publishedLocale","createVersion","createGlobalVersion","snapshotData","snapshotDate","updatedArgs","returning","err","errorMessage","labels","singular","label","logger","error","msg","max","versions","maxPerDoc","createdVersion"],"mappings":"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"}