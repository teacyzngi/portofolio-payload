{"version":3,"sources":["../../../src/auth/operations/logout.ts"],"sourcesContent":["import { status as httpStatus } from 'http-status'\n\nimport type { Collection } from '../../collections/config/types.js'\nimport type { PayloadRequest } from '../../types/index.js'\n\nimport { APIError } from '../../errors/index.js'\nimport { appendNonTrashedFilter } from '../../utilities/appendNonTrashedFilter.js'\n\nexport type Arguments = {\n  allSessions?: boolean\n  collection: Collection\n  req: PayloadRequest\n}\n\nexport const logoutOperation = async (incomingArgs: Arguments): Promise<boolean> => {\n  let args = incomingArgs\n  const {\n    allSessions,\n    collection: { config: collectionConfig },\n    req: { user },\n    req,\n  } = incomingArgs\n\n  if (!user) {\n    throw new APIError('No User', httpStatus.BAD_REQUEST)\n  }\n  if (user.collection !== collectionConfig.slug) {\n    throw new APIError('Incorrect collection', httpStatus.FORBIDDEN)\n  }\n\n  if (collectionConfig.hooks?.afterLogout?.length) {\n    for (const hook of collectionConfig.hooks.afterLogout) {\n      args =\n        (await hook({\n          collection: args.collection?.config,\n          context: req.context,\n          req,\n        })) || args\n    }\n  }\n\n  if (collectionConfig.auth.disableLocalStrategy !== true && collectionConfig.auth.useSessions) {\n    const where = appendNonTrashedFilter({\n      enableTrash: Boolean(collectionConfig.trash),\n      trash: false,\n      where: {\n        id: {\n          equals: user.id,\n        },\n      },\n    })\n\n    const userWithSessions = await req.payload.db.findOne<{\n      id: number | string\n      sessions: { id: string }[]\n    }>({\n      collection: collectionConfig.slug,\n      req,\n      where,\n    })\n\n    if (!userWithSessions) {\n      throw new APIError('No User', httpStatus.BAD_REQUEST)\n    }\n\n    if (allSessions) {\n      userWithSessions.sessions = []\n    } else {\n      const sessionsAfterLogout = (userWithSessions?.sessions || []).filter(\n        (s) => s.id !== req?.user?._sid,\n      )\n\n      userWithSessions.sessions = sessionsAfterLogout\n    }\n\n    // Ensure updatedAt date is always updated\n    ;(userWithSessions as any).updatedAt = new Date().toISOString()\n\n    await req.payload.db.updateOne({\n      id: user.id,\n      collection: collectionConfig.slug,\n      data: userWithSessions,\n      returning: false,\n    })\n  }\n\n  return true\n}\n"],"names":["status","httpStatus","APIError","appendNonTrashedFilter","logoutOperation","incomingArgs","args","allSessions","collection","config","collectionConfig","req","user","BAD_REQUEST","slug","FORBIDDEN","hooks","afterLogout","length","hook","context","auth","disableLocalStrategy","useSessions","where","enableTrash","Boolean","trash","id","equals","userWithSessions","payload","db","findOne","sessions","sessionsAfterLogout","filter","s","_sid","updatedAt","Date","toISOString","updateOne","data","returning"],"mappings":"AAAA,SAASA,UAAUC,UAAU,QAAQ,cAAa;AAKlD,SAASC,QAAQ,QAAQ,wBAAuB;AAChD,SAASC,sBAAsB,QAAQ,4CAA2C;AAQlF,OAAO,MAAMC,kBAAkB,OAAOC;IACpC,IAAIC,OAAOD;IACX,MAAM,EACJE,WAAW,EACXC,YAAY,EAAEC,QAAQC,gBAAgB,EAAE,EACxCC,KAAK,EAAEC,IAAI,EAAE,EACbD,GAAG,EACJ,GAAGN;IAEJ,IAAI,CAACO,MAAM;QACT,MAAM,IAAIV,SAAS,WAAWD,WAAWY,WAAW;IACtD;IACA,IAAID,KAAKJ,UAAU,KAAKE,iBAAiBI,IAAI,EAAE;QAC7C,MAAM,IAAIZ,SAAS,wBAAwBD,WAAWc,SAAS;IACjE;IAEA,IAAIL,iBAAiBM,KAAK,EAAEC,aAAaC,QAAQ;QAC/C,KAAK,MAAMC,QAAQT,iBAAiBM,KAAK,CAACC,WAAW,CAAE;YACrDX,OACE,AAAC,MAAMa,KAAK;gBACVX,YAAYF,KAAKE,UAAU,EAAEC;gBAC7BW,SAAST,IAAIS,OAAO;gBACpBT;YACF,MAAOL;QACX;IACF;IAEA,IAAII,iBAAiBW,IAAI,CAACC,oBAAoB,KAAK,QAAQZ,iBAAiBW,IAAI,CAACE,WAAW,EAAE;QAC5F,MAAMC,QAAQrB,uBAAuB;YACnCsB,aAAaC,QAAQhB,iBAAiBiB,KAAK;YAC3CA,OAAO;YACPH,OAAO;gBACLI,IAAI;oBACFC,QAAQjB,KAAKgB,EAAE;gBACjB;YACF;QACF;QAEA,MAAME,mBAAmB,MAAMnB,IAAIoB,OAAO,CAACC,EAAE,CAACC,OAAO,CAGlD;YACDzB,YAAYE,iBAAiBI,IAAI;YACjCH;YACAa;QACF;QAEA,IAAI,CAACM,kBAAkB;YACrB,MAAM,IAAI5B,SAAS,WAAWD,WAAWY,WAAW;QACtD;QAEA,IAAIN,aAAa;YACfuB,iBAAiBI,QAAQ,GAAG,EAAE;QAChC,OAAO;YACL,MAAMC,sBAAsB,AAACL,CAAAA,kBAAkBI,YAAY,EAAE,AAAD,EAAGE,MAAM,CACnE,CAACC,IAAMA,EAAET,EAAE,KAAKjB,KAAKC,MAAM0B;YAG7BR,iBAAiBI,QAAQ,GAAGC;QAC9B;QAEA,0CAA0C;;QACxCL,iBAAyBS,SAAS,GAAG,IAAIC,OAAOC,WAAW;QAE7D,MAAM9B,IAAIoB,OAAO,CAACC,EAAE,CAACU,SAAS,CAAC;YAC7Bd,IAAIhB,KAAKgB,EAAE;YACXpB,YAAYE,iBAAiBI,IAAI;YACjC6B,MAAMb;YACNc,WAAW;QACb;IACF;IAEA,OAAO;AACT,EAAC"}